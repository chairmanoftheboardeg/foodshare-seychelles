<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Account — FoodShare Seychelles</title>

  <link rel="icon" href="/image/logo.png" type="image/png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

  <style>
    :root {
      --primary-light:#81C784; --primary-main:#4CAF50; --primary-dark:#388E3C;
      --accent-blue:#2196F3; --accent-orange:#FF9800; --accent-red:#D32F2F;
      --neutral-bg:#F9F9F9; --neutral-card:#FFFFFF; --text-dark:#333333; --text-light:#666666;
      --shadow-subtle:0 10px 28px rgba(0,0,0,0.10);
      --font-serif:'Georgia', serif; --font-sans:'Helvetica Neue', Arial, sans-serif;
      --transition-speed:0.35s;
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:var(--font-sans); color:var(--text-dark); background:var(--neutral-bg); min-height:100vh; display:flex; flex-direction:column; }
    a { text-decoration:none; color:var(--primary-main); }
    a:hover { color:var(--primary-dark); }
    main { flex-grow:1; padding:40px 0; }
    h1,h2,h3 { font-family:var(--font-serif); color:var(--primary-dark); }
    .content-container { max-width:1050px; margin:0 auto; padding:0 25px; }

    /* NAVBAR */
    #navbar { display:flex; justify-content:space-between; align-items:center; padding:18px 25px; background-color:var(--neutral-card); box-shadow:0 4px 12px rgba(0,0,0,0.08); position:sticky; top:0; z-index:1000; }
    .logo-container { display:flex; align-items:center; font-size:1.6em; font-weight:bold; color:var(--text-dark); }
    .logo-img { height:40px; margin-right:10px; }
    .nav-links-container { display:flex; gap:22px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .nav-link { font-weight:600; padding:8px 0; position:relative; color:var(--text-dark); }
    .nav-link::after { content:''; position:absolute; width:0; height:2px; bottom:-5px; left:0; background-color:var(--primary-main); transition:width var(--transition-speed); }
    .nav-link:hover::after { width:100%; }
    .cta-button { background-color:var(--primary-main); color:#fff; border-radius:999px; padding:10px 18px; font-weight:800; box-shadow:0 10px 18px rgba(0,0,0,0.10); }
    .cta-button:hover { background-color:var(--primary-dark); }
    .staff-login { opacity:.9; }

    /* FOOTER */
    #main-footer { margin-top:auto; background-color:#222; color:var(--neutral-bg); padding:50px 0 20px; font-size:0.9em; }
    .footer-content { display:flex; justify-content:space-between; flex-wrap:wrap; margin-bottom:30px; max-width:1200px; margin:0 auto 30px; padding:0 25px; gap:18px; }
    .footer-section { width:20%; min-width:180px; margin-bottom:20px; }
    .footer-section h3 { color:var(--primary-light); margin-bottom:14px; font-size:1.1em; border-bottom:1px solid rgba(255,255,255,0.12); padding-bottom:6px; }
    .footer-section a { color:var(--neutral-bg); display:block; padding:3px 0; }
    .footer-section a:hover { color:var(--primary-main); text-decoration:underline; }
    .footer-bottom { text-align:center; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1); color:#aaa; font-size:0.85em; }

    /* Layout */
    .hero {
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap:18px;
      align-items:stretch;
    }
    @media (max-width: 920px){ .hero { grid-template-columns:1fr; } }

    .panel {
      background:var(--neutral-card);
      border-radius:18px;
      box-shadow:var(--shadow-subtle);
      border:1px solid rgba(56,142,60,0.14);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute; left:0; top:0; right:0; height:7px;
      background:linear-gradient(90deg, var(--primary-dark), var(--primary-main), var(--primary-light));
    }
    .panel-inner{ padding:22px; }

    .info h1{ font-size:2rem; margin-bottom:8px; }
    .info p{ color:var(--text-light); line-height:1.75; }
    .info .bullets{
      margin-top:14px;
      background:rgba(129,199,132,0.14);
      border:1px solid rgba(56,142,60,0.18);
      padding:14px;
      border-radius:14px;
      color:var(--text-light);
      line-height:1.7;
    }
    .info .bullets b{ color:var(--primary-dark); }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .tab{
      border:none;
      background:#fff;
      border:1px solid rgba(0,0,0,0.10);
      color:var(--text-dark);
      border-radius:999px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:900;
    }
    .tab.active{
      background:rgba(129,199,132,0.20);
      border-color: rgba(56,142,60,0.24);
      color:var(--primary-dark);
    }

    label{ display:block; font-weight:900; margin:12px 0 6px; }
    input{
      width:100%;
      padding:12px 12px;
      border:1px solid #d0d5dd;
      border-radius:12px;
      outline:none;
      font-size:1rem;
      background:#fff;
    }
    input:focus{
      border-color: rgba(76,175,80,0.55);
      box-shadow: 0 0 0 4px rgba(76,175,80,0.14);
    }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 680px){ .row{ grid-template-columns:1fr; } }

    .btn{
      width:100%;
      margin-top:16px;
      border:none;
      border-radius:999px;
      padding:12px 14px;
      background:var(--primary-main);
      color:#fff;
      font-weight:900;
      font-size:1.05rem;
      cursor:pointer;
      box-shadow:0 12px 22px rgba(0,0,0,0.12);
    }
    .btn:hover{ background:var(--primary-dark); }
    .btn:disabled{ opacity:.65; cursor:not-allowed; }

    .linkrow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      color:var(--text-light);
      font-weight:700;
    }
    .smallbtn{
      border:none;
      background:transparent;
      color:var(--accent-blue);
      cursor:pointer;
      font-weight:900;
      padding:0;
    }
    .smallbtn:hover{ text-decoration:underline; }

    .msg{
      display:none;
      margin-top:14px;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      line-height:1.55;
    }
    .msg.ok{ background:rgba(129,199,132,0.22); color:var(--primary-dark); border:1px solid rgba(56,142,60,0.18); }
    .msg.err{ background:rgba(211,47,47,0.10); color:var(--accent-red); border:1px solid rgba(211,47,47,0.22); }
    .msg.info{ background:rgba(33,150,243,0.10); color:#0f4e8a; border:1px solid rgba(33,150,243,0.18); }

    /* Loading overlay */
    .loading {
      position:fixed; inset:0; background:rgba(249,249,249,0.92);
      display:none; align-items:center; justify-content:center; z-index:5000;
    }
    .spinner {
      width:54px; height:54px; border-radius:50%;
      border:6px solid rgba(76,175,80,0.18);
      border-top-color: var(--primary-main);
      animation: spin .9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }
  </style>

  <script>
    const SUPABASE_URL = 'https://edotvuleaydztulkxehe.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkb3R2dWxlYXlkenR1bGt4ZWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDAyNDYsImV4cCI6MjA4MTE3NjI0Nn0.gDni31MI8twOpNmNcIpj1jGsra75eZ2iLL6gQM0i9lw';

    let supabase;

    function qs(id){ return document.getElementById(id); }
    function setLoading(on){ qs('loading').style.display = on ? 'flex' : 'none'; }

    function getNextUrl(){
      const u = new URL(window.location.href);
      const next = u.searchParams.get('next');
      return next || '/dashboard/';
    }

    function showMsg(kind, html){
      const el = qs('msg');
      el.className = 'msg ' + kind;
      el.innerHTML = html;
      el.style.display = 'block';
    }

    function setMode(mode){
      qs('msg').style.display = 'none';

      qs('tabSignIn').classList.toggle('active', mode === 'signin');
      qs('tabSignUp').classList.toggle('active', mode === 'signup');

      qs('signInBox').style.display = (mode === 'signin') ? 'block' : 'none';
      qs('signUpBox').style.display = (mode === 'signup') ? 'block' : 'none';
    }

    async function tryUpsertProfile(userId, email, fullName){
      // Best-effort profile creation across common schemas.
      // If you have a trigger already, this can harmlessly fail or no-op.
      const payloads = [
        { id: userId, email, full_name: fullName, role: 4 },
        { id: userId, email, full_name: fullName },
        { id: userId, email, name: fullName, role: 4 },
        { id: userId, email, name: fullName },
        { id: userId, email }
      ];

      for (const p of payloads){
        const { error } = await supabase.from('profiles').upsert([p], { onConflict: 'id' });
        if (!error) return true;

        // If table doesn't exist or RLS blocks insert, stop trying (no spam).
        const msg = (error.message || '').toLowerCase();
        if (msg.includes('row-level security') || msg.includes('rls') || msg.includes('permission denied')){
          console.warn('profiles upsert blocked by RLS:', error.message);
          return false;
        }
        if (msg.includes('relation') && msg.includes('does not exist')){
          console.warn('profiles table missing:', error.message);
          return false;
        }
        // otherwise try next payload variant
      }
      return false;
    }

    async function signIn(e){
      e.preventDefault();
      qs('msg').style.display = 'none';

      const email = qs('inEmail').value.trim();
      const password = qs('inPassword').value;

      qs('inBtn').disabled = true;
      qs('inBtn').textContent = 'Signing in...';

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });

      qs('inBtn').disabled = false;
      qs('inBtn').textContent = 'Sign In';

      if (error){
        return showMsg('err', `<i class="fa-solid fa-circle-xmark"></i> ${error.message}`);
      }

      // Ensure profile exists (best effort)
      await tryUpsertProfile(data.user.id, data.user.email, '');

      window.location.href = getNextUrl();
    }

    async function signUp(e){
      e.preventDefault();
      qs('msg').style.display = 'none';

      const fullName = qs('upName').value.trim();
      const email = qs('upEmail').value.trim();
      const password = qs('upPassword').value;

      qs('upBtn').disabled = true;
      qs('upBtn').textContent = 'Creating account...';

      // IMPORTANT: set email redirect back to your domain
      const redirectTo = 'https://www.foodshare-seychelles.online/account/';

      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: redirectTo,
          data: { full_name: fullName }
        }
      });

      qs('upBtn').disabled = false;
      qs('upBtn').textContent = 'Create Account';

      if (error){
        return showMsg('err', `<i class="fa-solid fa-circle-xmark"></i> ${error.message}`);
      }

      // If email confirmation is ON, session may be null (this is normal).
      if (!data.session){
        showMsg(
          'info',
          `<i class="fa-solid fa-envelope"></i> Account created. Please check your email to confirm your address, then return here and sign in.`
        );
        setMode('signin');
        return;
      }

      // If session exists, we can create profile immediately.
      await tryUpsertProfile(data.user.id, data.user.email, fullName);

      showMsg('ok', `<i class="fa-solid fa-circle-check"></i> Account created successfully. Redirecting...`);
      setTimeout(() => { window.location.href = getNextUrl(); }, 700);
    }

    async function sendReset(){
      qs('msg').style.display = 'none';

      const email = (qs('inEmail').value || '').trim();
      if (!email) return showMsg('err', `<i class="fa-solid fa-triangle-exclamation"></i> Enter your email first, then click “Forgot password”.`);

      const redirectTo = 'https://www.foodshare-seychelles.online/account/';
      const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });

      if (error){
        return showMsg('err', `<i class="fa-solid fa-circle-xmark"></i> ${error.message}`);
      }
      showMsg('info', `<i class="fa-solid fa-envelope"></i> Password reset email sent. Open it and you’ll be brought back here to set a new password.`);
    }

    async function handleRecoveryIfPresent(){
      // Supabase recovery links often come back with tokens in the URL hash.
      // Example: /account/#access_token=...&refresh_token=...&type=recovery
      const hash = window.location.hash || '';
      if (!hash.includes('type=recovery')) return;

      const params = new URLSearchParams(hash.replace(/^#/, ''));
      const access_token = params.get('access_token');
      const refresh_token = params.get('refresh_token');

      if (!access_token || !refresh_token){
        return showMsg('err', `<i class="fa-solid fa-circle-xmark"></i> Recovery link is missing tokens. Please request a new password reset.`);
      }

      setLoading(true);
      const { error } = await supabase.auth.setSession({ access_token, refresh_token });
      setLoading(false);

      if (error){
        return showMsg('err', `<i class="fa-solid fa-circle-xmark"></i> ${error.message}`);
      }

      // Show password update UI
      qs('recoveryBox').style.display = 'block';
      qs('signInBox').style.display = 'none';
      qs('signUpBox').style.display = 'none';
      qs('tabs').style.display = 'none';
      showMsg('info', `<i class="fa-solid fa-lock"></i> Set your new password below.`);
    }

    async function updatePassword(e){
      e.preventDefault();
      qs('msg').style.display = 'none';

      const p1 = qs('newPass').value;
      const p2 = qs('newPass2').value;
      if (p1.length < 8) return showMsg('err', `<i class="fa-solid fa-triangle-exclamation"></i> Password must be at least 8 characters.`);
      if (p1 !== p2) return showMsg('err', `<i class="fa-solid fa-triangle-exclamation"></i> Passwords do not match.`);

      qs('pwBtn').disabled = true;
      qs('pwBtn').textContent = 'Updating...';

      const { error } = await supabase.auth.updateUser({ password: p1 });

      qs('pwBtn').disabled = false;
      qs('pwBtn').textContent = 'Update Password';

      if (error){
        return showMsg('err', `<i class="fa-solid fa-circle-xmark"></i> ${error.message}`);
      }

      showMsg('ok', `<i class="fa-solid fa-circle-check"></i> Password updated. You can now sign in.`);
      // Clear hash (security)
      history.replaceState({}, document.title, window.location.pathname + window.location.search);
      // Back to sign in
      qs('recoveryBox').style.display = 'none';
      qs('tabs').style.display = 'flex';
      setMode('signin');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      qs('tabSignIn').addEventListener('click', () => setMode('signin'));
      qs('tabSignUp').addEventListener('click', () => setMode('signup'));

      qs('signInForm').addEventListener('submit', signIn);
      qs('signUpForm').addEventListener('submit', signUp);
      qs('forgotBtn').addEventListener('click', sendReset);
      qs('pwForm').addEventListener('submit', updatePassword);

      setMode('signin');
      await handleRecoveryIfPresent();
    });
  </script>
</head>

<body>
  <div id="loading" class="loading"><div class="spinner"></div></div>

  <header id="navbar">
    <a href="/" class="logo-container">
      <img src="/image/logo.png" alt="FoodShare Seychelles Logo" class="logo-img">
      FoodShare <span style="color: var(--primary-main);">Seychelles</span>
    </a>

    <nav class="nav-links-container">
      <a href="/available-food/" class="nav-link">Find Food</a>
      <a href="/donate-now/" class="nav-link">Donate</a>
      <a href="/volunteer-now/" class="nav-link">Volunteer</a>
      <a href="/our-impact/" class="nav-link">Impact</a>
      <a href="/about/" class="nav-link">About Us</a>
      <a href="/donate-now/" class="cta-button">DONATE NOW</a>
      <a href="/staff-login/" class="staff-login nav-link">Staff Login</a>
    </nav>
  </header>

  <main>
    <div class="content-container">
      <div class="hero">

        <section class="panel info">
          <div class="panel-inner">
            <h1>Community Account</h1>
            <p>
              Create an account to submit claims, track updates, and receive notifications directly on your FoodShare Seychelles dashboard.
            </p>
            <div class="bullets">
              <div><b><i class="fa-solid fa-bell"></i> Notifications:</b> receive automatic updates when staff reviews your requests.</div>
              <div style="margin-top:8px;"><b><i class="fa-solid fa-hand-holding-heart"></i> Faster claims:</b> claim food listings with fewer steps.</div>
              <div style="margin-top:8px;"><b><i class="fa-solid fa-shield"></i> Secure access:</b> managed by Supabase authentication.</div>
            </div>
            <p style="margin-top:14px; color:var(--text-light);">
              Note: Staff/Admin accounts use the separate <a href="/staff-login/">Staff Login</a>.
            </p>
          </div>
        </section>

        <section class="panel">
          <div class="panel-inner">
            <div id="tabs" class="tabs">
              <button id="tabSignIn" class="tab active" type="button"><i class="fa-solid fa-right-to-bracket"></i> Sign In</button>
              <button id="tabSignUp" class="tab" type="button"><i class="fa-solid fa-user-plus"></i> Create Account</button>
            </div>

            <div id="msg" class="msg"></div>

            <!-- Sign In -->
            <div id="signInBox">
              <h2 style="font-size:1.25rem;">Sign In</h2>
              <form id="signInForm">
                <label for="inEmail">Email Address</label>
                <input id="inEmail" type="email" required placeholder="you@example.com" />

                <label for="inPassword">Password</label>
                <input id="inPassword" type="password" required placeholder="Your password" />

                <button id="inBtn" class="btn" type="submit">
                  <i class="fa-solid fa-right-to-bracket"></i> Sign In
                </button>

                <div class="linkrow">
                  <span>Forgot your password?</span>
                  <button id="forgotBtn" class="smallbtn" type="button">Send reset email</button>
                </div>
              </form>
            </div>

            <!-- Sign Up -->
            <div id="signUpBox" style="display:none;">
              <h2 style="font-size:1.25rem;">Create Account</h2>
              <form id="signUpForm">
                <label for="upName">Full Name</label>
                <input id="upName" type="text" required placeholder="First & Last name" />

                <label for="upEmail">Email Address</label>
                <input id="upEmail" type="email" required placeholder="you@example.com" />

                <label for="upPassword">Password</label>
                <input id="upPassword" type="password" required minlength="8" placeholder="Minimum 8 characters" />

                <button id="upBtn" class="btn" type="submit">
                  <i class="fa-solid fa-user-plus"></i> Create Account
                </button>

                <div class="linkrow">
                  <span>Already have an account?</span>
                  <button class="smallbtn" type="button" onclick="document.getElementById('tabSignIn').click()">Sign in</button>
                </div>
              </form>
            </div>

            <!-- Recovery -->
            <div id="recoveryBox" style="display:none;">
              <h2 style="font-size:1.25rem;">Set New Password</h2>
              <form id="pwForm">
                <label for="newPass">New Password</label>
                <input id="newPass" type="password" required minlength="8" placeholder="Minimum 8 characters" />

                <label for="newPass2">Confirm New Password</label>
                <input id="newPass2" type="password" required minlength="8" placeholder="Repeat the password" />

                <button id="pwBtn" class="btn" type="submit">
                  <i class="fa-solid fa-lock"></i> Update Password
                </button>
              </form>
            </div>

          </div>
        </section>

      </div>
    </div>
  </main>

  <footer id="main-footer">
    <div class="content-container footer-content">
      <div class="footer-section"><h3>Quick Links</h3><ul><li><a href="/available-food/">Find Food</a></li><li><a href="/donate-now/">Donate</a></li><li><a href="/volunteer-now/">Volunteer</a></li><li><a href="/our-impact/">Impact</a></li><li><a href="/contact-general/">General Contact</a></li></ul></div>
      <div class="footer-section"><h3>Learn More</h3><ul><li><a href="/about/">About FoodShare</a></li><li><a href="/our-partners/">Our Partners</a></li><li><a href="/learn/safety/">Food Safety Protocol</a></li><li><a href="/learn/faq/">General FAQ</a></li></ul></div>
      <div class="footer-section"><h3>Support & Legal</h3><ul><li><a href="/privacy-policy/">Privacy Policy</a></li><li><a href="/terms-of-use/">Terms of Use</a></li><li><a href="/sitemap/">Site Structure</a></li><li><a href="/staff-login/">Staff Login</a></li></ul></div>
      <div class="footer-section">
        <h3>Get In Touch</h3>
        <p>Email: <a href="mailto:admin@foodshare-seychelles.online" style="color: var(--primary-main);">admin@foodshare-seychelles.online</a></p>
        <p>Follow us on <a href="/social/" style="color: var(--primary-main); display:inline;">Social Media</a></p>
      </div>
    </div>
    <div class="footer-bottom">&copy; 2025 Foodshare Seychelles. All Rights Reserved.</div>
  </footer>
</body>
</html>
