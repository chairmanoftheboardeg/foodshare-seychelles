<script>
  const SUPABASE_URL = 'https://edotvuleaydztulkxehe.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkb3R2dWxlYXlkenR1bGt4ZWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDAyNDYsImV4cCI6MjA4MTE3NjI0Nn0.gDni31MI8twOpNmNcIpj1jGsra75eZ2iLL6gQM0i9lw';
  let supabase;

  mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNrdW1scDBsbjFwZ2wyb29nOG82dWp4MjMifQ.3980_yJj-iY6S6o0-1H47Q';

  let donationMap;
  let donationMarker;
  let selectedCoordinates = null;

  function showMessage(type, message) {
    const msgEl = document.getElementById('statusMessage');
    msgEl.className = type;   // success | error
    msgEl.innerHTML = message || '';
    msgEl.style.display = message ? 'block' : 'none';
  }

  function initializeMap() {
    donationMap = new mapboxgl.Map({
      container: 'mapbox-picker',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [55.4522, -4.6796],
      zoom: 10
    });

    const geocoder = new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapboxgl: mapboxgl,
      marker: false,
      placeholder: 'Search for your pickup address...',
      proximity: { longitude: 55.4522, latitude: -4.6796 }
    });

    document.getElementById('geocoder-placeholder').appendChild(geocoder.onAdd(donationMap));

    geocoder.on('result', function (e) {
      const lngLat = e.result.geometry.coordinates;
      const addressText = e.result.place_name;

      document.getElementById('pickup_address').value = addressText;
      selectedCoordinates = `${lngLat[1]},${lngLat[0]}`; // lat,lng

      updateMarker(lngLat);
    });

    donationMap.on('click', function (e) {
      const lngLat = e.lngLat;
      selectedCoordinates = `${lngLat.lat},${lngLat.lng}`;

      fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lngLat.lng},${lngLat.lat}.json?access_token=${mapboxgl.accessToken}`)
        .then(r => r.json())
        .then(data => {
          if (data.features?.length > 0) {
            document.getElementById('pickup_address').value = data.features[0].place_name;
          } else {
            document.getElementById('pickup_address').value = `Coordinates: ${lngLat.lat}, ${lngLat.lng}`;
          }
        })
        .catch(() => {
          document.getElementById('pickup_address').value = `Coordinates: ${lngLat.lat}, ${lngLat.lng}`;
        });

      updateMarker([lngLat.lng, lngLat.lat]);
    });
  }

  function updateMarker(lngLatArray) {
    if (donationMarker) donationMarker.remove();

    donationMarker = new mapboxgl.Marker({ color: '#388E3C' })  // FIXED
      .setLngLat(lngLatArray)
      .addTo(donationMap);
  }

  async function handleDonationSubmit(event) {
    event.preventDefault();
    showMessage('', '');

    if (!selectedCoordinates) {
      showMessage('error', `<i class="fas fa-map-marker-alt"></i> Please select your pickup location on the map.`);
      return;
    }

    const formData = new FormData(event.target);

    const donationData = {
      donor_name: formData.get('donor_name'),
      donor_email: formData.get('donor_email'),
      donor_phone: formData.get('donor_phone'),
      food_type: formData.get('food_type'),
      quantity_kg: parseFloat(formData.get('quantity_kg')),
      expiry_date: formData.get('expiry_date') || null,
      storage_type: formData.get('storage_type'),
      description: formData.get('description'),
      pickup_address: document.getElementById('pickup_address').value,
      pickup_island: formData.get('pickup_island'),
      preferred_pickup_time: formData.get('preferred_pickup_time'),
      pickup_coordinates: selectedCoordinates,
      status: 'New'
    };

    if (isNaN(donationData.quantity_kg) || donationData.quantity_kg <= 0) {
      showMessage('error', `<i class="fas fa-exclamation-triangle"></i> Please enter a valid quantity (kg) greater than zero.`);
      return;
    }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = 'Submitting Request...';

    const { error } = await supabase.from('donations').insert([donationData]);

    if (error) {
      console.error('Donation Submission Error:', error);
      showMessage('error',
        `<i class="fas fa-times-circle"></i> Submission Failed: ${error.message}<br><br>
         If this says <b>row-level security</b>, you must add the public insert policy for the donations table.`
      );
      btn.disabled = false;
      btn.textContent = 'Submit Donation Request';
      return;
    }

    showMessage('success',
      `<i class="fas fa-check-circle"></i> <b>Thank you, ${donationData.donor_name}!</b><br>
       Your donation request has been submitted. Our team will contact you shortly.`
    );

    document.getElementById('donationForm').reset();
    btn.style.display = 'none';
  }

  document.addEventListener('DOMContentLoaded', () => {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    initializeMap();
    document.getElementById('donationForm').addEventListener('submit', handleDonationSubmit);
  });
</script>
