<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Donate Food - FoodShare Seychelles</title>

  <link rel="icon" href="/image/logo.png" type="image/png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js" defer></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.min.js" defer></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.css" rel="stylesheet" />

  <style>
    /* [START STANDARD SITE-WIDE CSS BLOCK] */
    :root {
      --primary-light: #81C784; --primary-main: #4CAF50; --primary-dark: #388E3C;
      --accent-blue: #2196F3; --accent-orange: #FF9800; --accent-red: #D32F2F;
      --neutral-bg: #F9F9F9; --neutral-card: #FFFFFF; --text-dark: #333333;
      --text-light: #666666; --shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.08);
      --font-serif: 'Georgia', serif; --font-sans: 'Helvetica Neue', Arial, sans-serif;
      --transition-speed: 0.4s;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-sans);
      color: var(--text-dark);
      background-color: var(--neutral-bg);
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    a { text-decoration: none; color: var(--primary-main); transition: color var(--transition-speed); }
    a:hover { color: var(--primary-dark); }
    main { flex-grow: 1; padding: 40px 0; }
    h1, h2, h3 { font-family: var(--font-serif); color: var(--primary-dark); }
    .content-container { max-width: 900px; margin: 0 auto; padding: 0 25px; }

    /* NAVIGATION BAR */
    #navbar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 18px 25px; background-color: var(--neutral-card);
      box-shadow: var(--shadow-subtle); position: sticky; top: 0; z-index: 1000;
    }
    .logo-container { display: flex; align-items: center; font-size: 1.6em; font-weight: bold; color: var(--text-dark); }
    .logo-img { height: 40px; margin-right: 10px; }
    .nav-links-container { display: flex; gap: 30px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
    .nav-link { font-weight: 500; padding: 8px 0; position: relative; color: var(--text-dark); }
    .nav-link::after {
      content: ''; position: absolute; width: 0; height: 2px; bottom: -5px; left: 0;
      background-color: var(--primary-main); transition: width var(--transition-speed);
    }
    .nav-link:hover::after { width: 100%; }
    .cta-button {
      background-color: var(--primary-main); color: var(--neutral-card);
      border-radius: 50px; padding: 10px 25px; font-weight: bold;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: background-color var(--transition-speed), transform 0.2s;
    }
    .cta-button:hover { background-color: var(--primary-dark); transform: translateY(-2px); }

    /* FOOTER */
    #main-footer {
      margin-top: auto; background-color: var(--text-dark); color: var(--neutral-bg);
      padding: 50px 0 20px; font-size: 0.9em;
    }
    .footer-content {
      display: flex; justify-content: space-between; flex-wrap: wrap;
      margin-bottom: 30px; max-width: 1200px; margin: 0 auto 30px; padding: 0 25px;
    }
    .footer-section { width: 20%; min-width: 150px; margin-bottom: 20px; }
    .footer-section h3 {
      color: var(--primary-light); margin-bottom: 20px; font-size: 1.2em;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 5px;
    }
    .footer-section a { color: var(--neutral-bg); transition: color 0.3s; display: block; padding: 3px 0; }
    .footer-section a:hover { color: var(--primary-main); text-decoration: underline; }
    .footer-bottom {
      text-align: center; padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1); color: #aaa; font-size: 0.8em;
    }

    /* Page / Form */
    .page-header { text-align: center; margin-bottom: 25px; }
    .page-header p { color: var(--text-light); margin-top: 8px; }

    .notice {
      background: #fff8e9;
      border: 1px solid #ffe4bd;
      border-radius: 12px;
      padding: 14px 16px;
      margin: 16px 0 0;
      color: #6c4500;
      font-weight: 600;
    }

    .form-card {
      background-color: var(--neutral-card);
      padding: 35px;
      border-radius: 12px;
      box-shadow: var(--shadow-subtle);
      margin-top: 18px;
      border-top: 5px solid var(--primary-main);
    }

    h2 {
      font-size: 1.25em; margin: 28px 0 14px;
      color: var(--text-dark);
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 8px;
      display: flex; align-items: center; gap: 10px;
      font-family: var(--font-serif);
    }

    label { display: block; margin-bottom: 6px; font-weight: 800; color: var(--text-dark); }
    input[type="text"], input[type="email"], input[type="tel"], input[type="number"], input[type="date"], select, textarea {
      width: 100%; padding: 12px; margin-bottom: 16px;
      border: 1px solid #ccc; border-radius: 8px; font-size: 1em;
      background: white;
    }
    textarea { min-height: 90px; resize: vertical; }

    .form-row { display: flex; gap: 18px; }
    .form-row > div { flex: 1; }

    .map-help {
      color: var(--text-light);
      font-size: .92em;
      margin: 8px 0 12px;
    }
    .geocoder-container { margin-bottom: 12px; }
    .geocoder-container .mapboxgl-ctrl-geocoder { width: 100% !important; max-width: none; }

    .map-container {
      position: relative;
      width: 100%;
      height: 320px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e7e7e7;
      background: #f2f2f2;
      margin-bottom: 14px;
    }
    #mapbox-picker { height: 100%; width: 100%; }

    .submit-btn {
      background-color: var(--primary-main);
      color: white;
      padding: 12px 22px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 900;
      transition: background-color var(--transition-speed), transform .15s;
      width: 100%;
      margin-top: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .submit-btn:hover { background-color: var(--primary-dark); transform: translateY(-1px); }
    .submit-btn:disabled { opacity: 0.7; cursor: not-allowed; transform:none; }

    #statusMessage {
      padding: 16px;
      border-radius: 12px;
      margin: 18px 0 0;
      font-weight: 800;
      display: none;
    }
    .success { background-color: #e9f7ea; border: 1px solid #cfead1; color: #1b6b2a; }
    .error { background-color: #ffe9e9; border: 1px solid #ffcaca; color: #8a1515; }

    .small-muted { font-size: .85em; color: var(--text-light); margin-top: 12px; text-align:center; }

    @media (max-width: 680px) { .form-row { flex-direction: column; gap: 0; } }
    /* [END STANDARD SITE-WIDE CSS BLOCK] */
  </style>
</head>

<body>
  <header id="navbar">
    <a href="/" class="logo-container">
      <img src="/image/logo.png" alt="FoodShare Seychelles Logo" class="logo-img">
      FoodShare <span style="color: var(--primary-main);">Seychelles</span>
    </a>
    <nav class="nav-links-container" id="navLinks">
      <a href="/available-food/" class="nav-link">Find Food</a>
      <a href="/donate-food/" class="nav-link">Donate</a>
      <a href="/volunteer/" class="nav-link">Volunteer</a>
      <a href="/impact/" class="nav-link">Impact</a>
      <a href="/about/" class="nav-link">About Us</a>
      <a href="/donate-food/" class="cta-button">DONATE NOW</a>
      <a href="/staff-login/" class="staff-login nav-link">Staff Login</a>
    </nav>
  </header>

  <main>
    <div class="content-container">
      <div class="page-header">
        <h1><i class="fas fa-leaf"></i> Donate Surplus Food</h1>
        <p>Help us rescue safe, quality food before it goes to waste. Fill out the form below and we’ll arrange collection.</p>
        <div class="notice">
          <i class="fas fa-triangle-exclamation"></i>
          We only accept food that is safe, unexpired (or near-expiry), and suitable for distribution.
        </div>
      </div>

      <div id="statusMessage"></div>

      <div class="form-card">
        <form id="donationForm">
          <h2><i class="fas fa-user-circle"></i> Donor Contact Details</h2>

          <label for="donor_name">Your Name or Organization Name *</label>
          <input type="text" id="donor_name" name="donor_name" required />

          <div class="form-row">
            <div>
              <label for="donor_email">Email Address *</label>
              <input type="email" id="donor_email" name="donor_email" required />
            </div>
            <div>
              <label for="donor_phone">Phone Number</label>
              <input type="tel" id="donor_phone" name="donor_phone" placeholder="e.g., 251-0000" />
            </div>
          </div>

          <h2><i class="fas fa-boxes"></i> Food Donation Details</h2>

          <div class="form-row">
            <div>
              <label for="food_type">Type of Food *</label>
              <select id="food_type" name="food_type" required>
                <option value="">-- Select Category --</option>
                <option value="Produce">Fresh Fruits & Vegetables</option>
                <option value="Packaged">Dry & Packaged Goods (Cans, Pasta, Rice)</option>
                <option value="Baked">Baked Goods (Bread, Pastries)</option>
                <option value="Meat">Meat & Poultry (Frozen/Chilled)</option>
                <option value="Dairy">Dairy & Eggs (Chilled)</option>
                <option value="Beverages">Non-Alcoholic Beverages</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <label for="quantity_kg">Estimated Quantity (kg) *</label>
              <input type="number" id="quantity_kg" name="quantity_kg" step="0.5" min="1" placeholder="Minimum 1 kg" required />
            </div>
          </div>

          <div class="form-row">
            <div>
              <label for="expiry_date">Best Before / Expiry Date</label>
              <input type="date" id="expiry_date" name="expiry_date" />
            </div>
            <div>
              <label for="storage_type">Current Storage Condition</label>
              <select id="storage_type" name="storage_type">
                <option value="Ambient">Ambient (Room Temperature)</option>
                <option value="Refrigerated">Refrigerated (Chilled)</option>
                <option value="Frozen">Frozen</option>
              </select>
            </div>
          </div>

          <label for="description">Detailed Description of Food Items</label>
          <textarea id="description" name="description" placeholder="e.g., 20kg tomatoes, 5 boxes canned beans, pickup by 4PM."></textarea>

          <h2><i class="fas fa-map-marker-alt"></i> Pickup Location & Timing</h2>

          <div class="map-help">
            Use the search box or click the map to set the pickup point. If the map fails to load, you can manually enter address/coordinates below.
          </div>

          <div id="geocoder-placeholder" class="geocoder-container"></div>

          <div class="map-container">
            <div id="mapbox-picker"></div>
          </div>

          <label for="pickup_address_visible">Pickup Address *</label>
          <input type="text" id="pickup_address_visible" placeholder="Will be filled by map selection…" required />

          <div class="form-row">
            <div>
              <label for="pickup_coordinates_visible">Pickup Coordinates (lat,lng) *</label>
              <input type="text" id="pickup_coordinates_visible" placeholder="Example: -4.6796,55.4522" required />
            </div>
            <div>
              <label for="pickup_island">Island Location *</label>
              <select id="pickup_island" name="pickup_island" required>
                <option value="">-- Select Island --</option>
                <option value="Mahe">Mahé</option>
                <option value="Praslin">Praslin</option>
                <option value="La Digue">La Digue</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <label for="preferred_pickup_time">Preferred Pickup Timeframe</label>
          <input type="text" id="preferred_pickup_time" name="preferred_pickup_time" placeholder="e.g., Tomorrow between 10am-12pm" />

          <button type="submit" id="submitBtn" class="submit-btn">
            <i class="fas fa-check-circle"></i> Submit Donation Request
          </button>

          <div class="small-muted">
            All donations are subject to review to ensure food safety standards are met.
          </div>
        </form>
      </div>
    </div>
  </main>

  <footer id="main-footer">
    <div class="content-container footer-content">
      <div class="footer-section">
        <h3>Quick Links</h3>
        <ul>
          <li><a href="/available-food/">Find Food</a></li>
          <li><a href="/donate-food/">Donate Food</a></li>
          <li><a href="/volunteer/">Volunteer</a></li>
          <li><a href="/impact/">Impact & Reports</a></li>
          <li><a href="/contact-general/">General Contact</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h3>Learn More</h3>
        <ul>
          <li><a href="/about/">About FoodShare</a></li>
          <li><a href="/our-partners/">Our Partners</a></li>
          <li><a href="/learn/safety/">Food Safety Protocol</a></li>
          <li><a href="/learn/faq/">General FAQ</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h3>Support & Legal</h3>
        <ul>
          <li><a href="/privacy-policy/">Privacy Policy</a></li>
          <li><a href="/terms-of-use/">Terms of Use</a></li>
          <li><a href="/sitemap/">Site Structure</a></li>
          <li><a href="/staff-login/">Staff Login</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h3>Get In Touch</h3>
        <p>Email: <a href="mailto:admin@foodshare-seychelles.online" style="color: var(--primary-main);">admin@foodshare-seychelles.online</a></p>
        <p>Follow us on <a href="/social/" style="color: var(--primary-main); display: inline;">Social Media</a></p>
      </div>
    </div>
    <div class="footer-bottom">&copy; 2025 Foodshare Seychelles. All Rights Reserved.</div>
  </footer>

  <script>
    const SUPABASE_URL = 'https://edotvuleaydztulkxehe.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkb3R2dWxlYXlkenR1bGt4ZWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDAyNDYsImV4cCI6MjA4MTE3NjI0Nn0.gDni31MI8twOpNmNcIpj1jGsra75eZ2iLL6gQM0i9lw';

    // Replace with your own Mapbox public token if you have one.
    const MAPBOX_TOKEN = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNrdW1scDBsbjFwZ2wyb29nOG82dWp4MjMifQ.3980_yJj-iY6S6o0-1H47Q';

    let supabaseClient = null;
    let donationMap = null;
    let donationMarker = null;

    function showMessage(type, html) {
      const el = document.getElementById('statusMessage');
      if (!html) {
        el.style.display = 'none';
        el.className = '';
        el.innerHTML = '';
        return;
      }
      el.className = type; // success | error
      el.innerHTML = html;
      el.style.display = 'block';
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function setCoordinates(lat, lng) {
      const coord = `${lat},${lng}`;
      document.getElementById('pickup_coordinates_visible').value = coord;
    }

    function setAddress(address) {
      document.getElementById('pickup_address_visible').value = address || '';
    }

    function updateMarker(lngLatArray) {
      if (!window.mapboxgl) return;
      if (donationMarker) donationMarker.remove();
      donationMarker = new mapboxgl.Marker({ color: '#388E3C' })
        .setLngLat(lngLatArray)
        .addTo(donationMap);
    }

    async function reverseGeocode(lng, lat) {
      try {
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${encodeURIComponent(MAPBOX_TOKEN)}`;
        const res = await fetch(url);
        const data = await res.json();
        return data?.features?.[0]?.place_name || `Coordinates: ${lat}, ${lng}`;
      } catch {
        return `Coordinates: ${lat}, ${lng}`;
      }
    }

    function initMapbox() {
      if (!window.mapboxgl || !window.MapboxGeocoder) {
        showMessage('error',
          `<i class="fas fa-triangle-exclamation"></i> Map could not be loaded. You can still submit by manually entering address and coordinates.`
        );
        return;
      }

      mapboxgl.accessToken = MAPBOX_TOKEN;

      donationMap = new mapboxgl.Map({
        container: 'mapbox-picker',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [55.4522, -4.6796], // Seychelles
        zoom: 10
      });

      const geocoder = new MapboxGeocoder({
        accessToken: MAPBOX_TOKEN,
        mapboxgl,
        marker: false,
        placeholder: 'Search for your pickup address...',
        proximity: { longitude: 55.4522, latitude: -4.6796 }
      });

      document.getElementById('geocoder-placeholder').appendChild(geocoder.onAdd(donationMap));

      geocoder.on('result', (e) => {
        const [lng, lat] = e.result.geometry.coordinates;
        setAddress(e.result.place_name);
        setCoordinates(lat, lng);
        updateMarker([lng, lat]);
      });

      donationMap.on('click', async (e) => {
        const lat = e.lngLat.lat;
        const lng = e.lngLat.lng;
        setCoordinates(lat, lng);
        updateMarker([lng, lat]);

        const addr = await reverseGeocode(lng, lat);
        setAddress(addr);
      });
    }

    function parseLatLng(input) {
      const raw = (input || '').trim();
      const parts = raw.split(',').map(s => s.trim());
      if (parts.length !== 2) return null;
      const lat = Number(parts[0]);
      const lng = Number(parts[1]);
      if (Number.isNaN(lat) || Number.isNaN(lng)) return null;
      if (lat < -90 || lat > 90 || lng < -180 || lng > 180) return null;
      return { lat, lng };
    }

    async function handleDonationSubmit(e) {
      e.preventDefault();
      showMessage('', '');

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting…';

      const donor_name = document.getElementById('donor_name').value.trim();
      const donor_email = document.getElementById('donor_email').value.trim();
      const donor_phone = document.getElementById('donor_phone').value.trim();
      const food_type = document.getElementById('food_type').value;
      const quantity_kg = Number(document.getElementById('quantity_kg').value);
      const expiry_date = document.getElementById('expiry_date').value || null;
      const storage_type = document.getElementById('storage_type').value;
      const description = document.getElementById('description').value.trim();
      const pickup_address = document.getElementById('pickup_address_visible').value.trim();
      const pickup_island = document.getElementById('pickup_island').value;
      const preferred_pickup_time = document.getElementById('preferred_pickup_time').value.trim();
      const coordInput = document.getElementById('pickup_coordinates_visible').value;

      if (!donor_name || !donor_email || !food_type || !pickup_address || !pickup_island) {
        showMessage('error', `<i class="fas fa-times-circle"></i> Please fill all required fields (*).`);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Donation Request';
        return;
      }

      if (!Number.isFinite(quantity_kg) || quantity_kg <= 0) {
        showMessage('error', `<i class="fas fa-times-circle"></i> Please enter a valid quantity (kg) greater than zero.`);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Donation Request';
        return;
      }

      const parsed = parseLatLng(coordInput);
      if (!parsed) {
        showMessage('error', `<i class="fas fa-times-circle"></i> Please provide valid coordinates in the format: <b>lat,lng</b> (example: -4.6796,55.4522).`);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Donation Request';
        return;
      }

      const pickup_coordinates = `${parsed.lat},${parsed.lng}`;

      const donationData = {
        donor_name,
        donor_email,
        donor_phone: donor_phone || null,
        food_type,
        quantity_kg,
        expiry_date,
        storage_type,
        description: description || null,
        pickup_address,
        pickup_island,
        preferred_pickup_time: preferred_pickup_time || null,
        pickup_coordinates,
        status: 'New'
      };

      const { error } = await supabaseClient.from('donations').insert([donationData]);

      if (error) {
        console.error('Donation insert error:', error);
        showMessage(
          'error',
          `<i class="fas fa-times-circle"></i> Submission Failed: ${error.message}<br><br>
           If the error mentions <b>row-level security</b>, you must allow public insert on the <b>donations</b> table in Supabase RLS.`
        );
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Donation Request';
        return;
      }

      showMessage(
        'success',
        `<i class="fas fa-check-circle"></i> <b>Thank you, ${donor_name}!</b><br>
         Your donation request has been submitted. Our team will contact you shortly to schedule pickup.`
      );

      document.getElementById('donationForm').reset();
      btn.style.display = 'none';
    }

    window.addEventListener('load', () => {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Initialize map safely
      initMapbox();

      // Hook form
      document.getElementById('donationForm').addEventListener('submit', handleDonationSubmit);
    });
  </script>
</body>
</html>
