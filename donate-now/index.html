<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Donate Now — FoodShare Seychelles</title>

  <link rel="icon" href="/image/logo.png" type="image/png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

  <!-- Leaflet (no key required) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <style>
    :root {
      --primary-light:#81C784; --primary-main:#4CAF50; --primary-dark:#388E3C;
      --accent-blue:#2196F3; --accent-orange:#FF9800; --accent-red:#D32F2F;
      --neutral-bg:#F9F9F9; --neutral-card:#FFFFFF; --text-dark:#333333; --text-light:#666666;
      --shadow-subtle:0 10px 28px rgba(0,0,0,0.10);
      --font-serif:'Georgia', serif; --font-sans:'Helvetica Neue', Arial, sans-serif;
      --transition-speed:0.35s;
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:var(--font-sans); color:var(--text-dark); background:var(--neutral-bg); min-height:100vh; display:flex; flex-direction:column; }
    a { text-decoration:none; color:var(--primary-main); }
    a:hover { color:var(--primary-dark); }
    main { flex-grow:1; padding:40px 0; }
    h1,h2,h3 { font-family:var(--font-serif); color:var(--primary-dark); }
    .content-container { max-width:980px; margin:0 auto; padding:0 25px; }

    /* NAVBAR */
    #navbar { display:flex; justify-content:space-between; align-items:center; padding:18px 25px; background-color:var(--neutral-card); box-shadow:0 4px 12px rgba(0,0,0,0.08); position:sticky; top:0; z-index:1000; }
    .logo-container { display:flex; align-items:center; font-size:1.6em; font-weight:bold; color:var(--text-dark); }
    .logo-img { height:40px; margin-right:10px; }
    .nav-links-container { display:flex; gap:22px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .nav-link { font-weight:600; padding:8px 0; position:relative; color:var(--text-dark); }
    .nav-link::after { content:''; position:absolute; width:0; height:2px; bottom:-5px; left:0; background-color:var(--primary-main); transition:width var(--transition-speed); }
    .nav-link:hover::after { width:100%; }
    .cta-button { background-color:var(--primary-main); color:#fff; border-radius:999px; padding:10px 18px; font-weight:800; box-shadow:0 10px 18px rgba(0,0,0,0.10); }
    .cta-button:hover { background-color:var(--primary-dark); }
    .staff-login { opacity:.9; }

    /* FOOTER */
    #main-footer { margin-top:auto; background-color:#222; color:var(--neutral-bg); padding:50px 0 20px; font-size:0.9em; }
    .footer-content { display:flex; justify-content:space-between; flex-wrap:wrap; margin-bottom:30px; max-width:1200px; margin:0 auto 30px; padding:0 25px; gap:18px; }
    .footer-section { width:20%; min-width:180px; margin-bottom:20px; }
    .footer-section h3 { color:var(--primary-light); margin-bottom:14px; font-size:1.1em; border-bottom:1px solid rgba(255,255,255,0.12); padding-bottom:6px; }
    .footer-section a { color:var(--neutral-bg); display:block; padding:3px 0; }
    .footer-section a:hover { color:var(--primary-main); text-decoration:underline; }
    .footer-bottom { text-align:center; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1); color:#aaa; font-size:0.85em; }

    /* Card */
    .panel {
      background:var(--neutral-card);
      border-radius:18px;
      box-shadow:var(--shadow-subtle);
      border:1px solid rgba(56,142,60,0.14);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute; left:0; top:0; right:0; height:7px;
      background:linear-gradient(90deg, var(--primary-dark), var(--primary-main), var(--primary-light));
    }
    .panel-inner{ padding:22px; }
    .head h1{ font-size:2rem; margin-bottom:6px; }
    .sub{ color:var(--text-light); line-height:1.7; }

    form { margin-top:16px; }
    label { display:block; font-weight:900; margin:12px 0 6px; }
    input, select, textarea {
      width:100%;
      padding:12px 12px;
      border:1px solid #d0d5dd;
      border-radius:12px;
      outline:none;
      font-size:1rem;
      background:#fff;
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(76,175,80,0.55);
      box-shadow: 0 0 0 4px rgba(76,175,80,0.14);
    }
    textarea { resize: vertical; min-height: 100px; }

    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 680px){ .row{ grid-template-columns:1fr; } }

    .map-box{
      margin-top:10px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,0.10);
      background:#fff;
    }
    #map{ width:100%; height:320px; }

    .helper-row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;
    }
    .mini-btn{
      border:none;
      background:#fff;
      border:1px solid rgba(56,142,60,0.22);
      color:var(--primary-dark);
      font-weight:900;
      border-radius:999px;
      padding:10px 12px;
      cursor:pointer;
    }
    .mini-btn:hover{ background:rgba(129,199,132,0.12); }

    .btn{
      width:100%;
      margin-top:16px;
      border:none;
      border-radius:999px;
      padding:12px 14px;
      background:var(--primary-main);
      color:#fff;
      font-weight:900;
      font-size:1.05rem;
      cursor:pointer;
      box-shadow:0 12px 22px rgba(0,0,0,0.12);
    }
    .btn:hover{ background:var(--primary-dark); }
    .btn:disabled{ opacity:.65; cursor:not-allowed; }

    .msg{
      display:none;
      margin-top:14px;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      line-height:1.55;
    }
    .msg.ok{ background:rgba(129,199,132,0.22); color:var(--primary-dark); border:1px solid rgba(56,142,60,0.18); }
    .msg.err{ background:rgba(211,47,47,0.10); color:var(--accent-red); border:1px solid rgba(211,47,47,0.22); }
    .msg.info{ background:rgba(33,150,243,0.10); color:#0f4e8a; border:1px solid rgba(33,150,243,0.18); }

    /* Loading */
    .loading {
      position:fixed; inset:0; background:rgba(249,249,249,0.92);
      display:none; align-items:center; justify-content:center; z-index:5000;
    }
    .spinner {
      width:54px; height:54px; border-radius:50%;
      border:6px solid rgba(76,175,80,0.18);
      border-top-color: var(--primary-main);
      animation: spin .9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }
  </style>

  <script>
    const SUPABASE_URL = 'https://edotvuleaydztulkxehe.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkb3R2dWxlYXlkenR1bGt4ZWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDAyNDYsImV4cCI6MjA4MTE3NjI0Nn0.gDni31MI8twOpNmNcIpj1jGsra75eZ2iLL6gQM0i9lw';

    let supabase;

    let map, marker;
    let chosenLatLng = null;
    let chosenAddress = '';

    function qs(id){ return document.getElementById(id); }
    function setLoading(on){ qs('loading').style.display = on ? 'flex' : 'none'; }

    function showMsg(kind, html){
      const el = qs('msg');
      el.className = 'msg ' + kind;
      el.innerHTML = html;
      el.style.display = 'block';
    }

    async function reverseGeocode(lat, lng){
      try{
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}`;
        const r = await fetch(url, { headers: { 'Accept':'application/json' }});
        if (!r.ok) throw new Error('reverse failed');
        const j = await r.json();
        chosenAddress = j?.display_name ? j.display_name : '';
      } catch {
        chosenAddress = '';
      }
    }

    function paint(){
      qs('pickupCoords').value = chosenLatLng ? `${chosenLatLng.lat.toFixed(6)}, ${chosenLatLng.lng.toFixed(6)}` : '';
      if (chosenAddress) qs('pickupAddress').value = chosenAddress;
    }

    function initMap(lat, lng){
      map = L.map('map').setView([lat, lng], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      marker = L.marker([lat, lng], { draggable:true }).addTo(map);
      chosenLatLng = { lat, lng };

      marker.on('dragend', async () => {
        const p = marker.getLatLng();
        chosenLatLng = { lat: p.lat, lng: p.lng };
        await reverseGeocode(p.lat, p.lng);
        paint();
      });

      map.on('click', async (e) => {
        marker.setLatLng(e.latlng);
        chosenLatLng = { lat: e.latlng.lat, lng: e.latlng.lng };
        await reverseGeocode(e.latlng.lat, e.latlng.lng);
        paint();
      });
    }

    async function useGps(){
      if (!navigator.geolocation){
        showMsg('err', `<i class="fa-solid fa-triangle-exclamation"></i> GPS not supported on this device.`);
        return;
      }
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        if (!map){
          initMap(lat, lng);
        } else {
          map.setView([lat, lng], 14);
          marker.setLatLng([lat, lng]);
          chosenLatLng = { lat, lng };
        }
        await reverseGeocode(lat, lng);
        paint();
      }, () => {
        showMsg('err', `<i class="fa-solid fa-circle-xmark"></i> GPS permission denied. You can still set location using the map pin.`);
      }, { enableHighAccuracy:true, timeout:10000 });
    }

    async function ipSeed(){
      try{
        const r = await fetch('https://ipapi.co/json/');
        if (!r.ok) throw new Error('ip failed');
        const j = await r.json();
        if (j?.latitude && j?.longitude){
          return { lat: parseFloat(j.latitude), lng: parseFloat(j.longitude) };
        }
      } catch {}
      // fallback to Seychelles center
      return { lat: -4.6796, lng: 55.4522 };
    }

    function val(id){ return qs(id).value.trim(); }

    async function submitDonation(e){
      e.preventDefault();
      qs('msg').style.display = 'none';

      if (!chosenLatLng){
        return showMsg('err', `<i class="fa-solid fa-map-location-dot"></i> Please select your pickup location using the map pin.`);
      }

      const donor_name = val('donorName');
      const donor_email = val('donorEmail');
      const donor_phone = val('donorPhone');

      const food_type = qs('foodType').value;
      const quantity = parseFloat(qs('quantityKg').value);
      const expiry_date = qs('expiryDate').value || null;
      const storage_type = qs('storageType').value;
      const description = val('description');

      const pickup_island = qs('pickupIsland').value;
      const preferred_pickup_time = val('pickupTime');
      const pickup_address = val('pickupAddress');

      if (!food_type) return showMsg('err', `<i class="fa-solid fa-triangle-exclamation"></i> Please select a food type.`);
      if (!pickup_island) return showMsg('err', `<i class="fa-solid fa-triangle-exclamation"></i> Please select an island location.`);
      if (!Number.isFinite(quantity) || quantity <= 0) return showMsg('err', `<i class="fa-solid fa-triangle-exclamation"></i> Please enter a valid quantity (kg).`);

      const btn = qs('submitBtn');
      btn.disabled = true;
      btn.textContent = 'Submitting...';

      // Insert payload (supports common donation schemas)
      const payload = {
        donor_name,
        donor_email,
        donor_phone,
        food_type,
        quantity_kg: quantity,
        expiry_date,
        storage_type,
        description,
        pickup_address,
        pickup_island,
        preferred_pickup_time,
        pickup_lat: chosenLatLng.lat,
        pickup_lng: chosenLatLng.lng,
        status: 'New'
      };

      const { error } = await supabase.from('donations').insert([payload]);

      if (error){
        console.error(error);
        btn.disabled = false;
        btn.textContent = 'Submit Donation Request';
        return showMsg('err', `<i class="fa-solid fa-circle-xmark"></i> Submission failed: ${error.message}`);
      }

      showMsg('ok', `<i class="fa-solid fa-circle-check"></i> Thank you, <b>${donor_name}</b>. Your donation request has been submitted successfully.`);
      qs('donationForm').reset();
      qs('pickupCoords').value = '';
      qs('pickupAddress').value = '';
      btn.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', async () => {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Wait for Leaflet (defer)
      const waitLeaflet = () => new Promise((resolve) => {
        const t = setInterval(() => { if (window.L) { clearInterval(t); resolve(); } }, 60);
      });

      try{
        setLoading(true);
        await waitLeaflet();

        const seed = await ipSeed();
        initMap(seed.lat, seed.lng);
        await reverseGeocode(seed.lat, seed.lng);
        paint();

        qs('gpsBtn').addEventListener('click', useGps);
        qs('donationForm').addEventListener('submit', submitDonation);
      } catch (e){
        console.error(e);
        showMsg('err', `<i class="fa-solid fa-circle-xmark"></i> Page error: ${e.message || e}`);
      } finally {
        setLoading(false);
      }
    });
  </script>
</head>

<body>
  <div id="loading" class="loading"><div class="spinner"></div></div>

  <header id="navbar">
    <a href="/" class="logo-container">
      <img src="/image/logo.png" alt="FoodShare Seychelles Logo" class="logo-img">
      FoodShare <span style="color: var(--primary-main);">Seychelles</span>
    </a>

    <nav class="nav-links-container">
      <a href="/available-food/" class="nav-link">Find Food</a>
      <a href="/donate-now/" class="nav-link">Donate</a>
      <a href="/volunteer-now/" class="nav-link">Volunteer</a>
      <a href="/our-impact/" class="nav-link">Impact</a>
      <a href="/about/" class="nav-link">About Us</a>
      <a href="/donate-now/" class="cta-button">DONATE NOW</a>
      <a href="/staff-login/" class="staff-login nav-link">Staff Login</a>
    </nav>
  </header>

  <main>
    <div class="content-container">
      <section class="panel">
        <div class="panel-inner">
          <div class="head">
            <h1><i class="fa-solid fa-gift"></i> Donate Food</h1>
            <div class="sub">
              Help us rescue safe surplus food before it goes to waste. Submit a request and our team will contact you to schedule collection.
            </div>
          </div>

          <div id="msg" class="msg"></div>

          <form id="donationForm">
            <h2 style="font-size:1.25rem; margin-top:12px;">Donor Details</h2>

            <label for="donorName">Full Name / Organization *</label>
            <input id="donorName" type="text" required placeholder="Your name or organization name" />

            <div class="row">
              <div>
                <label for="donorEmail">Email Address *</label>
                <input id="donorEmail" type="email" required placeholder="you@example.com" />
              </div>
              <div>
                <label for="donorPhone">Phone Number</label>
                <input id="donorPhone" type="tel" placeholder="e.g., 251-0000" />
              </div>
            </div>

            <h2 style="font-size:1.25rem; margin-top:18px;">Donation Details</h2>

            <div class="row">
              <div>
                <label for="foodType">Type of Food *</label>
                <select id="foodType" required>
                  <option value="">-- Select Category --</option>
                  <option value="Produce">Fresh Fruits & Vegetables</option>
                  <option value="Packaged">Dry & Packaged Goods</option>
                  <option value="Baked">Baked Goods</option>
                  <option value="Meat">Meat & Poultry</option>
                  <option value="Dairy">Dairy & Eggs</option>
                  <option value="Beverages">Non-Alcoholic Beverages</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div>
                <label for="quantityKg">Estimated Quantity (kg) *</label>
                <input id="quantityKg" type="number" step="0.5" min="0.5" required placeholder="e.g., 10" />
              </div>
            </div>

            <div class="row">
              <div>
                <label for="expiryDate">Best Before / Expiry Date</label>
                <input id="expiryDate" type="date" />
              </div>
              <div>
                <label for="storageType">Current Storage Condition</label>
                <select id="storageType">
                  <option value="Ambient">Ambient (Room Temperature)</option>
                  <option value="Refrigerated">Refrigerated (Chilled)</option>
                  <option value="Frozen">Frozen</option>
                </select>
              </div>
            </div>

            <label for="description">Detailed Description</label>
            <textarea id="description" placeholder="e.g., 20kg tomatoes, must be picked up by 4 PM"></textarea>

            <h2 style="font-size:1.25rem; margin-top:18px;"><i class="fa-solid fa-map-location-dot"></i> Pickup Location</h2>
            <div class="sub">Drag the pin or tap the map to set the exact pickup point.</div>

            <div class="helper-row">
              <button id="gpsBtn" class="mini-btn" type="button">
                <i class="fa-solid fa-location-crosshairs"></i> Use my GPS
              </button>
              <span class="sub">You can also edit the address text manually if needed.</span>
            </div>

            <div class="map-box"><div id="map"></div></div>

            <div class="row" style="margin-top:10px;">
              <div>
                <label for="pickupCoords">Pickup Coordinates *</label>
                <input id="pickupCoords" type="text" readonly required />
              </div>
              <div>
                <label for="pickupIsland">Island Location *</label>
                <select id="pickupIsland" required>
                  <option value="">-- Select Island --</option>
                  <option value="Mahe">Mahé</option>
                  <option value="Praslin">Praslin</option>
                  <option value="La Digue">La Digue</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>

            <label for="pickupAddress">Pickup Address *</label>
            <input id="pickupAddress" type="text" required placeholder="Auto-filled from pin location (edit if needed)" />

            <label for="pickupTime">Preferred Pickup Timeframe</label>
            <input id="pickupTime" type="text" placeholder="e.g., Tomorrow between 10:00–12:00" />

            <button id="submitBtn" class="btn" type="submit">
              <i class="fa-solid fa-paper-plane"></i> Submit Donation Request
            </button>
          </form>
        </div>
      </section>
    </div>
  </main>

  <footer id="main-footer">
    <div class="content-container footer-content">
      <div class="footer-section"><h3>Quick Links</h3><ul><li><a href="/available-food/">Find Food</a></li><li><a href="/donate-now/">Donate</a></li><li><a href="/volunteer-now/">Volunteer</a></li><li><a href="/our-impact/">Impact</a></li><li><a href="/contact-general/">General Contact</a></li></ul></div>
      <div class="footer-section"><h3>Learn More</h3><ul><li><a href="/about/">About FoodShare</a></li><li><a href="/our-partners/">Our Partners</a></li><li><a href="/learn/safety/">Food Safety Protocol</a></li><li><a href="/learn/faq/">General FAQ</a></li></ul></div>
      <div class="footer-section"><h3>Support & Legal</h3><ul><li><a href="/privacy-policy/">Privacy Policy</a></li><li><a href="/terms-of-use/">Terms of Use</a></li><li><a href="/sitemap/">Site Structure</a></li><li><a href="/staff-login/">Staff Login</a></li></ul></div>
      <div class="footer-section">
        <h3>Get In Touch</h3>
        <p>Email: <a href="mailto:admin@foodshare-seychelles.online" style="color: var(--primary-main);">admin@foodshare-seychelles.online</a></p>
        <p>Follow us on <a href="/social/" style="color: var(--primary-main); display:inline;">Social Media</a></p>
      </div>
    </div>
    <div class="footer-bottom">&copy; 2025 Foodshare Seychelles. All Rights Reserved.</div>
  </footer>
</body>
</html>
