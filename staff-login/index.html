<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Login - FoodShare Seychelles</title>
    <link rel="icon" href="/image/logo.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <style> /* ... (Your existing CSS for the login page) ... */ </style>
    
    <script>
        const SUPABASE_URL = 'https://edotvuleaydztulkxehe.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkb3R2dWxlYXlkenR1bGt4ZWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDAyNDYsInl4cCI6MjA4MTE3NjI0Nn0.gDni31MI8twOpNmNcIpj1jGsra75eZ2iLL6gQM0i9lw';
        
        let supabase;

        document.addEventListener('DOMContentLoaded', async () => {
            const loginForm = document.getElementById('loginForm');
            const messageEl = document.getElementById('message');

            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } else {
                messageEl.textContent = 'ERROR: Core services failed to load.';
                return;
            }

            // --- Pre-check for existing session and direct navigation fix ---
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                const user = session.user;
                const { data: profile } = await supabase.from('profiles').select('role_id').eq('id', user.id).single();
                
                if (profile) {
                    if (profile.role_id === 1) {
                        // FIX: Redirect using clean directory path
                        window.location.href = '/admin-dashboard/';
                        return;
                    } else if (profile.role_id === 2) {
                        // FIX: Redirect using clean directory path
                        window.location.href = '/staff-dashboard/';
                        return;
                    }
                }
            }
            // --- End Pre-check ---

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                const { data, error } = await supabase.auth.signInWithPassword({ email, password });

                if (error) {
                    messageEl.textContent = `Login failed: ${error.message}`;
                    messageEl.className = 'alert-message alert-error';
                    return;
                }
                
                if (data.user) {
                    const user = data.user;
                    // Step 2: Check the user's role in the profiles table
                    const { data: profile, error: roleError } = await supabase
                        .from('profiles')
                        .select('role_id')
                        .eq('id', user.id)
                        .single();

                    if (roleError || !profile || !profile.role_id) {
                         messageEl.textContent = 'Account found, but role assignment missing. Contact Admin.';
                         messageEl.className = 'alert-message alert-error';
                         // Crucial: Log out immediately if role check fails for security
                         await supabase.auth.signOut();
                         return;
                    }

                    // Step 3: Redirect based on role
                    if (profile.role_id === 1) {
                         // FIX: Clean Redirect
                        window.location.href = '/admin-dashboard/';
                    } else if (profile.role_id === 2) {
                         // FIX: Clean Redirect
                        window.location.href = '/staff-dashboard/';
                    } else {
                        messageEl.textContent = 'Login successful, but role is unrecognized.';
                        messageEl.className = 'alert-message alert-error';
                        await supabase.auth.signOut();
                    }
                }
            });
        });
    </script>

</head>
<body>
    </body>
</html>
