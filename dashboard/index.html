<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Dashboard — FoodShare Seychelles</title>
  <link rel="icon" href="/image/logo.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

  <style>
    :root {
      --primary-light:#81C784; --primary-main:#4CAF50; --primary-dark:#388E3C;
      --accent-blue:#2196F3; --accent-orange:#FF9800; --accent-red:#D32F2F;
      --neutral-bg:#F9F9F9; --neutral-card:#FFFFFF; --text-dark:#333333; --text-light:#666666;
      --shadow-subtle:0 10px 28px rgba(0,0,0,0.10);
      --font-serif:'Georgia', serif; --font-sans:'Helvetica Neue', Arial, sans-serif;
      --transition-speed:0.35s;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--font-sans);color:var(--text-dark);background:var(--neutral-bg);min-height:100vh;display:flex;flex-direction:column}
    a{text-decoration:none;color:var(--primary-main)}
    a:hover{color:var(--primary-dark)}
    main{flex:1;padding:34px 0}
    .content-container{max-width:1150px;margin:0 auto;padding:0 25px}

    /* NAVBAR */
    #navbar{display:flex;justify-content:space-between;align-items:center;padding:18px 25px;background:var(--neutral-card);box-shadow:0 4px 12px rgba(0,0,0,0.08);position:sticky;top:0;z-index:1000}
    .logo-container{display:flex;align-items:center;font-size:1.6em;font-weight:bold;color:var(--text-dark)}
    .logo-img{height:40px;margin-right:10px}
    .nav-links-container{display:flex;gap:18px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .nav-link{font-weight:600;padding:8px 0;position:relative;color:var(--text-dark)}
    .nav-link::after{content:'';position:absolute;width:0;height:2px;bottom:-5px;left:0;background:var(--primary-main);transition:width var(--transition-speed)}
    .nav-link:hover::after{width:100%}

    .nav-actions{display:flex;align-items:center;gap:12px}
    .icon-btn{
      position:relative; border:1px solid rgba(56,142,60,0.16);
      background:#fff; border-radius:999px; padding:10px 12px; cursor:pointer;
      transition:transform .12s ease, box-shadow .2s ease;
    }
    .icon-btn:hover{box-shadow:0 10px 18px rgba(0,0,0,0.08)}
    .icon-btn:active{transform:translateY(1px)}
    .badge{
      position:absolute; top:-6px; right:-6px;
      background:var(--accent-red); color:#fff; font-weight:900;
      font-size:.75rem; padding:4px 7px; border-radius:999px;
      border:2px solid #fff;
      display:none;
    }
    .user-chip{
      display:flex;align-items:center;gap:10px;
      padding:8px 10px;border-radius:999px;background:rgba(129,199,132,0.15);
      border:1px solid rgba(56,142,60,0.18);
      max-width:260px;
    }
    .avatar{
      width:34px;height:34px;border-radius:50%;object-fit:cover;
      border:2px solid rgba(56,142,60,0.25); background:#fff;
    }
    .user-chip b{display:block;font-size:.92rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .user-chip span{display:block;font-size:.82rem;color:var(--text-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* FOOTER */
    #main-footer{margin-top:auto;background:#222;color:var(--neutral-bg);padding:50px 0 20px;font-size:.9em}
    .footer-content{display:flex;justify-content:space-between;flex-wrap:wrap;margin-bottom:30px;max-width:1200px;margin:0 auto 30px;padding:0 25px;gap:18px}
    .footer-section{width:20%;min-width:180px;margin-bottom:20px}
    .footer-section h3{color:var(--primary-light);margin-bottom:14px;font-size:1.1em;border-bottom:1px solid rgba(255,255,255,0.12);padding-bottom:6px}
    .footer-section a{color:var(--neutral-bg);display:block;padding:3px 0}
    .footer-section a:hover{color:var(--primary-main);text-decoration:underline}
    .footer-bottom{text-align:center;padding-top:20px;border-top:1px solid rgba(255,255,255,0.1);color:#aaa;font-size:.85em}

    /* LAYOUT */
    .grid{display:grid;grid-template-columns: 1.05fr 0.95fr;gap:18px;align-items:start}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--neutral-card);
      border-radius:16px;
      box-shadow:var(--shadow-subtle);
      border:1px solid rgba(56,142,60,0.14);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";position:absolute;left:0;top:0;right:0;height:6px;
      background:linear-gradient(90deg,var(--primary-dark),var(--primary-main),var(--primary-light));
    }
    .card-inner{padding:22px}
    h1,h2{font-family:var(--font-serif);color:var(--primary-dark)}
    h1{font-size:1.85rem;margin-bottom:6px}
    .sub{color:var(--text-light);line-height:1.7}

    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{
      border:none;border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer;
      background:var(--primary-main);color:#fff;box-shadow:0 10px 18px rgba(0,0,0,0.10);
    }
    .btn:hover{background:var(--primary-dark)}
    .btn.ghost{
      background:#fff;color:var(--primary-dark);border:1px solid rgba(56,142,60,0.22);box-shadow:none;
    }
    .btn.ghost:hover{background:rgba(129,199,132,0.12)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .list{margin-top:14px;display:grid;gap:10px}
    .item{
      border:1px solid rgba(0,0,0,0.06);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .item .top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .pill{
      font-size:.78rem;font-weight:900;padding:6px 10px;border-radius:999px;
      background:rgba(129,199,132,0.18);
      border:1px solid rgba(56,142,60,0.22);
      color:var(--primary-dark);
      white-space:nowrap;
    }
    .item p{margin-top:6px;color:var(--text-light);line-height:1.55}
    .muted{color:var(--text-light);font-size:.95rem}

    /* Notification dropdown */
    .dropdown{
      position:absolute; right:0; top:54px;
      width:min(420px, 92vw);
      background:#fff;
      border:1px solid rgba(0,0,0,0.10);
      border-radius:14px;
      box-shadow:0 18px 40px rgba(0,0,0,0.12);
      display:none;
      overflow:hidden;
      z-index:2000;
    }
    .dropdown header{
      padding:12px 14px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      background:rgba(129,199,132,0.16);
      border-bottom:1px solid rgba(56,142,60,0.14);
      font-weight:900;color:var(--primary-dark);
    }
    .dropdown .body{max-height:420px;overflow:auto}
    .drop-item{
      padding:12px 14px;border-bottom:1px solid rgba(0,0,0,0.06);
    }
    .drop-item:last-child{border-bottom:none}
    .drop-item b{display:block}
    .drop-item .meta{margin-top:4px;font-size:.85rem;color:var(--text-light)}
    .drop-item.unread{background:rgba(33,150,243,0.06)}
    .link-btn{border:none;background:transparent;color:var(--accent-blue);font-weight:900;cursor:pointer}
    .link-btn:hover{text-decoration:underline}

    /* Toast */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:20px;
      background:#fff;
      border:1px solid rgba(0,0,0,0.12);
      box-shadow:0 18px 40px rgba(0,0,0,0.12);
      border-radius:14px;
      padding:12px 14px;
      width:min(520px, 92vw);
      display:none;
      z-index:3000;
    }
    .toast b{color:var(--primary-dark)}
    .toast p{margin-top:4px;color:var(--text-light);line-height:1.45}

    /* Loading overlay */
    .loading{
      position:fixed; inset:0; background:rgba(249,249,249,0.9);
      display:flex; align-items:center; justify-content:center; z-index:5000;
    }
    .spinner{
      width:52px;height:52px;border-radius:50%;
      border:5px solid rgba(76,175,80,0.18);
      border-top-color: var(--primary-main);
      animation: spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Floating assistance button (stub now; links to your assistance form) */
    .assist-btn{
      position:fixed; right:18px; bottom:18px;
      width:56px; height:56px; border-radius:50%;
      background:var(--accent-blue); color:#fff;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 18px 40px rgba(0,0,0,0.18);
      cursor:pointer; z-index:2500;
      border: none;
    }
    .assist-btn:hover{filter:brightness(0.95)}
  </style>

  <script>
    const SUPABASE_URL = 'https://edotvuleaydztulkxehe.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkb3R2dWxlYXlkenR1bGt4ZWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDAyNDYsImV4cCI6MjA4MTE3NjI0Nn0.gDni31MI8twOpNmNcIpj1jGsra75eZ2iLL6gQM0i9lw';
    let supabase;
    let currentUser = null;
    let lastToastAt = 0;

    function qs(id){ return document.getElementById(id); }

    function setLoading(show){
      qs('loading').style.display = show ? 'flex' : 'none';
    }

    function toggleDropdown(show){
      qs('notifDropdown').style.display = show ? 'block' : 'none';
    }

    function setBadge(count){
      const b = qs('notifBadge');
      if (!count || count <= 0){ b.style.display = 'none'; b.textContent = ''; return; }
      b.style.display = 'inline-block';
      b.textContent = String(count);
    }

    function fmtTime(ts){
      try { return new Date(ts).toLocaleString(); } catch { return ''; }
    }

    function toast(title, body){
      const now = Date.now();
      if (now - lastToastAt < 2500) return;
      lastToastAt = now;

      qs('toastTitle').textContent = title || 'Update';
      qs('toastBody').textContent = body || '';
      qs('toast').style.display = 'block';
      setTimeout(() => { qs('toast').style.display = 'none'; }, 5200);
    }

    async function authGuard(){
      const { data } = await supabase.auth.getSession();
      if (!data?.session?.user){
        window.location.href = '/account/';
        return null;
      }
      currentUser = data.session.user;
      return currentUser;
    }

    async function loadProfile(){
      const { data, error } = await supabase
        .from('profiles')
        .select('full_name,email,phone,avatar_url,role,linkedin_url')
        .eq('id', currentUser.id)
        .single();

      if (error){
        qs('welcomeName').textContent = 'Welcome';
        return;
      }

      const name = data.full_name || 'Community Member';
      qs('welcomeName').textContent = `Welcome, ${name}`;
      qs('chipName').textContent = name;
      qs('chipEmail').textContent = data.email || currentUser.email || '';

      const avatar = data.avatar_url && data.avatar_url.trim() ? data.avatar_url.trim() : '/image/logo.png';
      qs('avatarImg').src = avatar;
      qs('avatarImg').alt = name + ' avatar';

      qs('profileName').textContent = name;
      qs('profileEmail').textContent = data.email || currentUser.email || '';
      qs('profilePhone').textContent = data.phone || 'Not set';
      qs('profileLinkedIn').innerHTML = data.linkedin_url
        ? `<a href="${data.linkedin_url}" target="_blank" rel="noopener">View LinkedIn</a>`
        : 'Not set';
    }

    async function updateAvatar(){
      const url = prompt('Paste your profile picture URL (must be a direct image URL):');
      if (!url) return;

      const { error } = await supabase
        .from('profiles')
        .update({ avatar_url: url, updated_at: new Date().toISOString() })
        .eq('id', currentUser.id);

      if (error) return toast('Update failed', error.message);
      toast('Profile updated', 'Your profile picture has been updated.');
      await loadProfile();
    }

    async function loadNotifications(){
      const { data, error } = await supabase
        .from('notifications')
        .select('id,title,body,type,is_read,created_at')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false })
        .limit(20);

      if (error){
        qs('notifList').innerHTML = `<div class="drop-item">Failed to load notifications.</div>`;
        setBadge(0);
        return;
      }

      const unread = data.filter(n => !n.is_read).length;
      setBadge(unread);

      if (!data.length){
        qs('notifList').innerHTML = `<div class="drop-item">No notifications yet.</div>`;
        return;
      }

      qs('notifList').innerHTML = data.map(n => `
        <div class="drop-item ${n.is_read ? '' : 'unread'}">
          <b>${n.title}</b>
          <div class="meta">${fmtTime(n.created_at)} • ${n.type}</div>
          <div class="meta" style="margin-top:6px;">${n.body}</div>
          ${n.is_read ? '' : `<div style="margin-top:8px;"><button class="link-btn" onclick="markNotifRead('${n.id}')">Mark read</button></div>`}
        </div>
      `).join('');
    }

    async function markNotifRead(id){
      const { error } = await supabase
        .from('notifications')
        .update({ is_read: true })
        .eq('id', id)
        .eq('user_id', currentUser.id);

      if (error) return toast('Update failed', error.message);
      await loadNotifications();
    }

    async function markAllRead(){
      const { error } = await supabase
        .from('notifications')
        .update({ is_read: true })
        .eq('user_id', currentUser.id)
        .eq('is_read', false);

      if (error) return toast('Update failed', error.message);
      await loadNotifications();
    }

    async function loadAdminMessages(){
      const { data, error } = await supabase
        .from('admin_messages')
        .select('id,subject,message,created_at,is_read')
        .eq('recipient_id', currentUser.id)
        .order('created_at', { ascending: false })
        .limit(10);

      if (error){
        qs('msgList').innerHTML = `<div class="item"><b>Messages</b><p>Failed to load messages.</p></div>`;
        return;
      }

      if (!data.length){
        qs('msgList').innerHTML = `<div class="item"><b>No messages yet</b><p class="muted">When admins contact you, messages will appear here.</p></div>`;
        return;
      }

      qs('msgList').innerHTML = data.map(m => `
        <div class="item">
          <div class="top">
            <div>
              <b>${m.subject}</b>
              <div class="muted">${fmtTime(m.created_at)} ${m.is_read ? '' : '• Unread'}</div>
            </div>
            ${m.is_read ? '' : `<button class="btn ghost" onclick="markMsgRead('${m.id}')">Mark read</button>`}
          </div>
          <p>${m.message}</p>
        </div>
      `).join('');
    }

    async function markMsgRead(id){
      const { error } = await supabase
        .from('admin_messages')
        .update({ is_read: true })
        .eq('id', id)
        .eq('recipient_id', currentUser.id);

      if (error) return toast('Update failed', error.message);
      await loadAdminMessages();
    }

    async function loadMyActivity(){
      // Optional: show recent claims/donations/apps if those tables exist
      let html = '';

      // Claims
      try {
        const { data } = await supabase
          .from('claims')
          .select('id,claim_type,status,created_at,listing_ref')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .limit(5);
        if (data?.length){
          html += `<div class="item"><div class="top"><b>Recent Claims</b><span class="pill">Last 5</span></div>
                   <p class="muted">${data.map(x => `${x.claim_type} • ${x.status} • ${fmtTime(x.created_at)}`).join('<br>')}</p></div>`;
        }
      } catch {}

      // Donations
      try {
        const { data } = await supabase
          .from('donations')
          .select('id,status,created_at,food_type,quantity_kg')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .limit(5);
        if (data?.length){
          html += `<div class="item"><div class="top"><b>Recent Donations</b><span class="pill">Last 5</span></div>
                   <p class="muted">${data.map(x => `${x.food_type || 'Donation'} • ${x.status || 'Submitted'} • ${fmtTime(x.created_at)}`).join('<br>')}</p></div>`;
        }
      } catch {}

      // Volunteer apps
      try {
        const { data } = await supabase
          .from('volunteer_applications')
          .select('id,status,submitted_at')
          .eq('user_id', currentUser.id)
          .order('submitted_at', { ascending: false })
          .limit(3);
        if (data?.length){
          html += `<div class="item"><div class="top"><b>Volunteer Application</b><span class="pill">Latest</span></div>
                   <p class="muted">${data.map(x => `${x.status || 'Submitted'} • ${fmtTime(x.submitted_at)}`).join('<br>')}</p></div>`;
        }
      } catch {}

      if (!html) html = `<div class="item"><b>No recent activity yet</b><p class="muted">Once you submit a claim, donation, or application, it will appear here.</p></div>`;
      qs('activityList').innerHTML = html;
    }

    async function logout(){
      await supabase.auth.signOut();
      window.location.href = '/account/';
    }

    async function pollNewNotifications(){
      // lightweight: just refresh counts + show toast if new unread arrives
      await loadNotifications();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      setLoading(true);
      const u = await authGuard();
      if (!u) return;

      await loadProfile();
      await loadNotifications();
      await loadAdminMessages();
      await loadMyActivity();

      // Navbar actions
      qs('notifBtn').addEventListener('click', () => {
        const open = qs('notifDropdown').style.display === 'block';
        toggleDropdown(!open);
      });
      document.addEventListener('click', (e) => {
        const dd = qs('notifDropdown');
        const btn = qs('notifBtn');
        if (!dd.contains(e.target) && !btn.contains(e.target)) toggleDropdown(false);
      });

      qs('markAllReadBtn').addEventListener('click', markAllRead);
      qs('logoutBtn').addEventListener('click', logout);
      qs('updateAvatarBtn').addEventListener('click', updateAvatar);

      // Poll notifications every 25s (simple + reliable)
      setInterval(pollNewNotifications, 25000);

      setLoading(false);
    });
  </script>
</head>

<body>
  <div id="loading" class="loading" aria-label="Loading">
    <div class="spinner" aria-hidden="true"></div>
  </div>

  <header id="navbar">
    <a href="/" class="logo-container">
      <img src="/image/logo.png" alt="FoodShare Seychelles Logo" class="logo-img">
      FoodShare <span style="color: var(--primary-main);">Seychelles</span>
    </a>

    <nav class="nav-links-container">
      <a href="/available-food/" class="nav-link">Find Food</a>
      <a href="/donate-now/" class="nav-link">Donate</a>
      <a href="/volunteer-now/" class="nav-link">Volunteer</a>
      <a href="/our-impact/" class="nav-link">Impact</a>
      <a href="/about/" class="nav-link">About Us</a>
    </nav>

    <div class="nav-actions" style="position:relative;">
      <div class="user-chip" title="My account">
        <img id="avatarImg" class="avatar" src="/image/logo.png" alt="avatar">
        <div style="min-width:0;">
          <b id="chipName">Loading...</b>
          <span id="chipEmail">...</span>
        </div>
      </div>

      <button id="notifBtn" class="icon-btn" type="button" aria-label="Notifications">
        <i class="fa-solid fa-bell"></i>
        <span id="notifBadge" class="badge">0</span>
      </button>

      <button id="logoutBtn" class="icon-btn" type="button" aria-label="Logout">
        <i class="fa-solid fa-right-from-bracket"></i>
      </button>

      <div id="notifDropdown" class="dropdown" role="dialog" aria-label="Notifications dropdown">
        <header>
          <span>Notifications</span>
          <button id="markAllReadBtn" class="link-btn" type="button">Mark all read</button>
        </header>
        <div id="notifList" class="body"></div>
      </div>
    </div>
  </header>

  <main>
    <div class="content-container">
      <div class="row" style="margin-bottom:14px;">
        <div>
          <h1 id="welcomeName">Welcome</h1>
          <div class="sub">This is your personal dashboard. You will receive updates here after you submit requests.</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn" href="/available-food/"><i class="fa-solid fa-basket-shopping" style="margin-right:8px;"></i>Find Food</a>
          <a class="btn ghost" href="/donate-now/"><i class="fa-solid fa-hand-holding-heart" style="margin-right:8px;"></i>Donate</a>
        </div>
      </div>

      <div class="grid">
        <section class="card">
          <div class="card-inner">
            <h2 style="margin-bottom:6px;">My Profile</h2>
            <div class="sub">Keep your details up to date for smoother communication.</div>

            <div class="list">
              <div class="item">
                <div class="top">
                  <div>
                    <b id="profileName">—</b>
                    <div class="muted" id="profileEmail">—</div>
                  </div>
                  <button id="updateAvatarBtn" class="btn ghost" type="button">Update Photo</button>
                </div>
                <p><b>Phone:</b> <span id="profilePhone">—</span></p>
                <p><b>LinkedIn:</b> <span id="profileLinkedIn">—</span></p>
              </div>

              <div class="item">
                <div class="top">
                  <b>Quick Actions</b>
                  <span class="pill">v1.1</span>
                </div>
                <p class="muted">
                  Submit requests using the website pages:
                  <br>• Claim food: <a href="/available-food/">Find Food</a>
                  <br>• Donate: <a href="/donate-now/">Donate Now</a>
                  <br>• Volunteer: <a href="/volunteer-now/">Volunteer Now</a>
                </p>
              </div>
            </div>
          </div>
        </section>

        <aside class="card">
          <div class="card-inner">
            <h2 style="margin-bottom:6px;">Updates & Messages</h2>
            <div class="sub">Official messages from admins will appear below.</div>

            <div class="list" id="msgList" style="margin-top:14px;"></div>

            <div style="margin-top:16px;">
              <h2 style="margin-bottom:6px;">My Activity</h2>
              <div class="sub">Your recent submissions (claims/donations/applications).</div>
              <div class="list" id="activityList"></div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <!-- Floating assistance button (currently links to your assistance form) -->
  <button class="assist-btn" type="button" title="Need help?"
    onclick="window.location.href='/general/assistance/'" aria-label="Need help">
    <i class="fa-solid fa-headset"></i>
  </button>

  <div id="toast" class="toast" role="status" aria-live="polite">
    <b id="toastTitle">Update</b>
    <p id="toastBody"></p>
  </div>

  <footer id="main-footer">
    <div class="content-container footer-content">
      <div class="footer-section"><h3>Quick Links</h3><ul><li><a href="/available-food/">Find Food</a></li><li><a href="/donate-now/">Donate</a></li><li><a href="/volunteer-now/">Volunteer</a></li><li><a href="/our-impact/">Impact</a></li><li><a href="/contact-general/">General Contact</a></li></ul></div>
      <div class="footer-section"><h3>Learn More</h3><ul><li><a href="/about/">About FoodShare</a></li><li><a href="/our-partners/">Our Partners</a></li><li><a href="/learn/safety/">Food Safety Protocol</a></li><li><a href="/learn/faq/">General FAQ</a></li></ul></div>
      <div class="footer-section"><h3>Support & Legal</h3><ul><li><a href="/privacy-policy/">Privacy Policy</a></li><li><a href="/terms-of-use/">Terms of Use</a></li><li><a href="/sitemap/">Site Structure</a></li><li><a href="/staff-login/">Staff Login</a></li></ul></div>
      <div class="footer-section">
        <h3>Get In Touch</h3>
        <p>Email: <a href="mailto:admin@foodshare-seychelles.online" style="color: var(--primary-main);">admin@foodshare-seychelles.online</a></p>
        <p>Follow us on <a href="/social/" style="color: var(--primary-main); display:inline;">Social Media</a></p>
      </div>
    </div>
    <div class="footer-bottom">&copy; 2025 Foodshare Seychelles. All Rights Reserved.</div>
  </footer>
</body>
</html>
