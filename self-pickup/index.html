<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Self Pickup â€” FoodShare Seychelles</title>

  <link rel="icon" href="/image/logo.png" type="image/png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

  <style>
    :root {
      --primary-light:#81C784; --primary-main:#4CAF50; --primary-dark:#388E3C;
      --accent-blue:#2196F3; --accent-orange:#FF9800; --accent-red:#D32F2F;
      --neutral-bg:#F9F9F9; --neutral-card:#FFFFFF; --text-dark:#333333; --text-light:#666666;
      --shadow-subtle:0 10px 28px rgba(0,0,0,0.10);
      --font-serif:'Georgia', serif; --font-sans:'Helvetica Neue', Arial, sans-serif;
      --transition-speed:0.35s;
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:var(--font-sans); color:var(--text-dark); background:var(--neutral-bg); min-height:100vh; display:flex; flex-direction:column; }
    a { text-decoration:none; color:var(--primary-main); }
    a:hover { color:var(--primary-dark); }
    main { flex-grow:1; padding:40px 0; }
    h1,h2,h3 { font-family:var(--font-serif); color:var(--primary-dark); }
    .content-container { max-width:900px; margin:0 auto; padding:0 25px; }

    /* NAVBAR */
    #navbar { display:flex; justify-content:space-between; align-items:center; padding:18px 25px; background-color:var(--neutral-card); box-shadow:0 4px 12px rgba(0,0,0,0.08); position:sticky; top:0; z-index:1000; }
    .logo-container { display:flex; align-items:center; font-size:1.6em; font-weight:bold; color:var(--text-dark); }
    .logo-img { height:40px; margin-right:10px; }
    .nav-links-container { display:flex; gap:22px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .nav-link { font-weight:600; padding:8px 0; position:relative; color:var(--text-dark); }
    .nav-link::after { content:''; position:absolute; width:0; height:2px; bottom:-5px; left:0; background-color:var(--primary-main); transition:width var(--transition-speed); }
    .nav-link:hover::after { width:100%; }
    .cta-button { background-color:var(--primary-main); color:#fff; border-radius:999px; padding:10px 18px; font-weight:800; box-shadow:0 10px 18px rgba(0,0,0,0.10); }
    .cta-button:hover { background-color:var(--primary-dark); }
    .staff-login { opacity:.9; }

    /* FOOTER */
    #main-footer { margin-top:auto; background-color:#222; color:var(--neutral-bg); padding:50px 0 20px; font-size:0.9em; }
    .footer-content { display:flex; justify-content:space-between; flex-wrap:wrap; margin-bottom:30px; max-width:1200px; margin:0 auto 30px; padding:0 25px; gap:18px; }
    .footer-section { width:20%; min-width:180px; margin-bottom:20px; }
    .footer-section h3 { color:var(--primary-light); margin-bottom:14px; font-size:1.1em; border-bottom:1px solid rgba(255,255,255,0.12); padding-bottom:6px; }
    .footer-section a { color:var(--neutral-bg); display:block; padding:3px 0; }
    .footer-section a:hover { color:var(--primary-main); text-decoration:underline; }
    .footer-bottom { text-align:center; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1); color:#aaa; font-size:0.85em; }

    .panel {
      background:var(--neutral-card);
      border-radius:16px;
      box-shadow:var(--shadow-subtle);
      border:1px solid rgba(56,142,60,0.14);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute; left:0; top:0; right:0; height:6px;
      background:linear-gradient(90deg, var(--primary-dark), var(--primary-main), var(--primary-light));
    }
    .panel-inner{ padding:22px; }

    .head h1{ font-size:2rem; margin-bottom:6px; }
    .sub{ color:var(--text-light); line-height:1.7; }

    label { display:block; font-weight:900; margin:12px 0 6px; }
    input, select, textarea {
      width:100%;
      padding:12px 12px;
      border:1px solid #d0d5dd;
      border-radius:12px;
      outline:none;
      font-size:1rem;
      background:#fff;
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(76,175,80,0.55);
      box-shadow: 0 0 0 4px rgba(76,175,80,0.14);
    }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 680px){ .row{ grid-template-columns:1fr; } }

    .msg{
      display:none;
      margin-top:14px;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      line-height:1.55;
    }
    .msg.ok{ background:rgba(129,199,132,0.22); color:var(--primary-dark); border:1px solid rgba(56,142,60,0.18); }
    .msg.err{ background:rgba(211,47,47,0.10); color:var(--accent-red); border:1px solid rgba(211,47,47,0.22); }

    .checkline{
      margin-top:10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      background:#fff;
      border:1px solid rgba(0,0,0,0.08);
      border-radius:14px;
      padding:12px;
    }
    .checkline input{ width:auto; margin-top:3px; }

    .btn{
      width:100%;
      margin-top:16px;
      border:none;
      border-radius:999px;
      padding:12px 14px;
      background:var(--primary-main);
      color:#fff;
      font-weight:900;
      font-size:1.05rem;
      cursor:pointer;
      box-shadow:0 12px 22px rgba(0,0,0,0.12);
    }
    .btn:hover{ background:var(--primary-dark); }
    .btn:disabled{ opacity:.65; cursor:not-allowed; }

    .loading {
      position:fixed; inset:0; background:rgba(249,249,249,0.92);
      display:none; align-items:center; justify-content:center; z-index:5000;
    }
    .spinner {
      width:54px; height:54px; border-radius:50%;
      border:6px solid rgba(76,175,80,0.18);
      border-top-color: var(--primary-main);
      animation: spin .9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }
  </style>

  <script>
    const SUPABASE_URL = 'https://edotvuleaydztulkxehe.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkb3R2dWxlYXlkenR1bGt4ZWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDAyNDYsImV4cCI6MjA4MTE3NjI0Nn0.gDni31MI8twOpNmNcIpj1jGsra75eZ2iLL6gQM0i9lw';

    let supabase;
    let user = null;

    let listingId = null;
    let listings = [];

    function qs(id){ return document.getElementById(id); }
    function setLoading(on){ qs('loading').style.display = on ? 'flex' : 'none'; }

    function getParam(name){
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    function showMsg(type, html){
      const el = qs('msg');
      el.className = 'msg ' + (type === 'ok' ? 'ok' : 'err');
      el.innerHTML = html;
      el.style.display = 'block';
    }

    async function requireAuth(){
      const { data } = await supabase.auth.getSession();
      user = data?.session?.user || null;

      if (!user){
        const next = `/self-pickup/?listing_id=${encodeURIComponent(listingId || '')}`;
        window.location.href = `/account/?next=${encodeURIComponent(next)}`;
        return false;
      }
      return true;
    }

    async function loadListings(){
      let res = await supabase
        .from('food_listings')
        .select('id,title,is_available')
        .eq('is_available', true)
        .order('posted_at', { ascending: false })
        .limit(150);

      if (res.error){
        const fallback = await supabase.from('food_listings').select('*').eq('is_available', true).limit(150);
        if (fallback.error) throw fallback.error;
        res = fallback;
      }

      listings = (res.data || []).map(x => ({ id: x.id, title: x.title || 'Food Listing' }));

      const sel = qs('listingSelect');
      sel.innerHTML = `<option value="">-- Select a listing --</option>` +
        listings.map(l => `<option value="${l.id}">${l.title}</option>`).join('');

      if (listingId){
        sel.value = listingId;
      }
    }

    async function submitForm(e){
      e.preventDefault();
      qs('msg').style.display = 'none';

      const fullName = qs('fullName').value.trim();
      const email = qs('email').value.trim();
      const phone = qs('phone').value.trim();
      const chosenListingId = qs('listingSelect').value;
      const signature = qs('signature').value.trim();
      const agree = qs('agree').checked;

      if (!chosenListingId){
        return showMsg('err', `<i class="fa-solid fa-triangle-exclamation"></i> Please select the food listing you are picking up.`);
      }
      if (!agree) return showMsg('err', `<i class="fa-solid fa-triangle-exclamation"></i> Please accept the Terms of Use to continue.`);
      if (!signature) return showMsg('err', `<i class="fa-solid fa-triangle-exclamation"></i> Signature is required.`);

      const listingTitle = (listings.find(x => String(x.id) === String(chosenListingId)) || {}).title || 'Food Listing';

      const btn = qs('submitBtn');
      btn.disabled = true;
      btn.textContent = 'Submitting...';

      const payloadV11 = {
        user_id: user.id,
        listing_ref: String(chosenListingId),
        claim_type: 'self_pickup',
        status: 'New',
        full_name: fullName,
        email,
        phone,
        pickup_confirm_text: listingTitle,
        signature_name: signature
      };

      const ins = await supabase.from('claims').insert([payloadV11]);

      if (ins.error){
        console.error(ins.error);
        btn.disabled = false;
        btn.textContent = 'Submit Self Pickup Request';
        return showMsg('err', `<i class="fa-solid fa-circle-xmark"></i> Submission failed: ${ins.error.message}`);
      }

      showMsg('ok', `<i class="fa-solid fa-circle-check"></i> Self pickup request submitted successfully. Updates will appear in your <a href="/dashboard/">dashboard</a>.`);
      btn.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', async () => {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      listingId = getParam('listing_id');

      try{
        setLoading(true);

        const ok = await requireAuth();
        if (!ok) return;

        await loadListings();
        qs('pickupForm').addEventListener('submit', submitForm);

      } catch (e){
        console.error(e);
        showMsg('err', `<i class="fa-solid fa-circle-xmark"></i> ${e.message || e}`);
      } finally {
        setLoading(false);
      }
    });
  </script>
</head>

<body>
  <div id="loading" class="loading"><div class="spinner"></div></div>

  <header id="navbar">
    <a href="/" class="logo-container">
      <img src="/image/logo.png" alt="FoodShare Seychelles Logo" class="logo-img">
      FoodShare <span style="color: var(--primary-main);">Seychelles</span>
    </a>

    <nav class="nav-links-container">
      <a href="/available-food/" class="nav-link">Find Food</a>
      <a href="/donate-now/" class="nav-link">Donate</a>
      <a href="/volunteer-now/" class="nav-link">Volunteer</a>
      <a href="/our-impact/" class="nav-link">Impact</a>
      <a href="/about/" class="nav-link">About Us</a>
      <a href="/donate-now/" class="cta-button">DONATE NOW</a>
      <a href="/staff-login/" class="staff-login nav-link">Staff Login</a>
    </nav>
  </header>

  <main>
    <div class="content-container">
      <section class="panel">
        <div class="panel-inner">
          <div class="head">
            <h1><i class="fa-solid fa-person-walking"></i> Self Pickup</h1>
            <div class="sub">
              Submit this form to confirm you will pick up the selected food listing yourself. Your request will be sent to FoodShare staff.
            </div>
          </div>

          <div id="msg" class="msg"></div>

          <form id="pickupForm">
            <h2 style="font-size:1.25rem; margin-top:10px;">Contact Details</h2>

            <div class="row">
              <div>
                <label for="fullName">Full Name *</label>
                <input id="fullName" type="text" required placeholder="Your full name" />
              </div>
              <div>
                <label for="email">Email Address *</label>
                <input id="email" type="email" required placeholder="you@example.com" />
              </div>
            </div>

            <label for="phone">Phone Number *</label>
            <input id="phone" type="tel" required placeholder="e.g., 251-0000" />

            <h2 style="font-size:1.25rem; margin-top:18px;">Pickup Confirmation</h2>

            <label for="listingSelect">Confirm the food listing you are picking up *</label>
            <select id="listingSelect" required></select>

            <label for="signature">Signature (First & Last Name) *</label>
            <input id="signature" type="text" required placeholder="Type your full name as signature" />

            <div class="checkline">
              <input id="agree" type="checkbox" required />
              <div class="sub">
                I confirm the information provided is accurate and I agree to the
                <a href="/terms-of-use/" target="_blank" rel="noopener">Terms of Use</a>.
              </div>
            </div>

            <button id="submitBtn" class="btn" type="submit">
              <i class="fa-solid fa-paper-plane"></i> Submit Self Pickup Request
            </button>
          </form>
        </div>
      </section>
    </div>
  </main>

  <footer id="main-footer">
    <div class="content-container footer-content">
      <div class="footer-section"><h3>Quick Links</h3><ul><li><a href="/available-food/">Find Food</a></li><li><a href="/donate-now/">Donate</a></li><li><a href="/volunteer-now/">Volunteer</a></li><li><a href="/our-impact/">Impact</a></li><li><a href="/contact-general/">General Contact</a></li></ul></div>
      <div class="footer-section"><h3>Learn More</h3><ul><li><a href="/about/">About FoodShare</a></li><li><a href="/our-partners/">Our Partners</a></li><li><a href="/learn/safety/">Food Safety Protocol</a></li><li><a href="/learn/faq/">General FAQ</a></li></ul></div>
      <div class="footer-section"><h3>Support & Legal</h3><ul><li><a href="/privacy-policy/">Privacy Policy</a></li><li><a href="/terms-of-use/">Terms of Use</a></li><li><a href="/sitemap/">Site Structure</a></li><li><a href="/staff-login/">Staff Login</a></li></ul></div>
      <div class="footer-section">
        <h3>Get In Touch</h3>
        <p>Email: <a href="mailto:admin@foodshare-seychelles.online" style="color: var(--primary-main);">admin@foodshare-seychelles.online</a></p>
        <p>Follow us on <a href="/social/" style="color: var(--primary-main); display:inline;">Social Media</a></p>
      </div>
    </div>
    <div class="footer-bottom">&copy; 2025 Foodshare Seychelles. All Rights Reserved.</div>
  </footer>
</body>
</html>
