<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management - FoodShare Seychelles</title>
    
    <link rel="icon" href="../image/logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    
    <style>
        /* [Standard CSS Block Omitted for brevity, assumed consistent with dashboard.html] */
        :root {
            --primary-light: #81C784; --primary-main: #4CAF50; --primary-dark: #388E3C; 
            --accent-blue: #2196F3; --accent-orange: #FF9800; --accent-red: #D32F2F;
            --neutral-bg: #F9F9F9; --neutral-card: #FFFFFF; --text-dark: #333333; 
            --text-light: #666666; --shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.08);
            --font-serif: 'Georgia', serif; --font-sans: 'Helvetica Neue', Arial, sans-serif;
            --transition-speed: 0.4s;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-sans); color: var(--text-dark); background-color: var(--neutral-bg); line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; }
        a { text-decoration: none; color: var(--primary-main); transition: color var(--transition-speed); }
        a:hover { color: var(--primary-dark); }
        main { flex-grow: 1; padding: 40px 0; }
        h1, h2, h3 { font-family: var(--font-serif); color: var(--primary-dark); }
        .content-container { max-width: 1400px; margin: 0 auto; padding: 0 25px; } 

        /* Navigation Bar */
        #navbar { display: flex; justify-content: space-between; align-items: center; padding: 18px 25px; background-color: var(--neutral-card); box-shadow: var(--shadow-subtle); position: sticky; top: 0; z-index: 1000; }
        .logo-container { display: flex; align-items: center; font-size: 1.6em; font-weight: bold; color: var(--text-dark); }
        .logo-img { height: 40px; margin-right: 10px; }
        .nav-links-container { display: flex; gap: 30px; align-items: center; }
        .nav-link { font-weight: 500; padding: 8px 0; position: relative; color: var(--text-dark); }
        
        /* Layout Specific */
        .grid-container { display: grid; grid-template-columns: 350px 1fr; gap: 30px; margin-top: 30px; }
        .form-card { background: var(--neutral-card); padding: 25px; border-radius: 8px; box-shadow: var(--shadow-subtle); }
        
        /* Form Styles */
        label { display: block; margin-top: 15px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="date"], textarea, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        #inventoryForm button { background-color: var(--primary-main); color: white; padding: 12px 25px; border: none; border-radius: 4px; margin-top: 25px; cursor: pointer; width: 100%; }
        
        /* Table Styles */
        .inventory-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .inventory-table th, .inventory-table td { padding: 10px 15px; border-bottom: 1px solid #eee; text-align: left; font-size: 0.9em; }
        .inventory-table th { background-color: var(--primary-light); color: var(--text-dark); font-weight: bold; }
        .inventory-table tr:hover { background-color: #f5f5f5; }
        
        .action-btn { padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px; }
        .edit-btn { background-color: var(--accent-blue); color: white; }
        .delete-btn { background-color: var(--accent-red); color: white; }
    </style>
    
    <script>
        const SUPABASE_URL = 'https://edotvuleaydztulkxehe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkb3R2dWxlYXlkenR1bGt4ZWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDAyNDYsImV4cCI6MjA4MTE3NjI0Nn0.gDni31MI8twOpNmNcIpj1jGsra75eZ2iLL6gQM0i9lw';
        let supabase;
        const ADMIN_ROLE_ID = 1;
        const STAFF_ROLES = [2, 3];
        let editingId = null; 

        // --- Core Functions ---

        async function checkAccessAndRedirect() {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = '/staff-login/index.html';
                return;
            }

            const { data: profileData, error } = await supabase
                .from('profiles')
                .select('role')
                .eq('id', session.user.id)
                .single();

            if (error || !profileData || profileData.role !== ADMIN_ROLE_ID) {
                // Redirect if not logged in as Admin
                window.location.href = '/staff-login/index.html'; 
                return;
            }
            
            fetchListings();
        }

        function clearForm() {
            document.getElementById('inventoryForm').reset();
            document.getElementById('formTitle').textContent = 'Add New Inventory Item';
            document.getElementById('submitBtn').textContent = 'Add Listing';
            editingId = null;
        }

        async function fetchListings() {
            const listingsBody = document.getElementById('listingsTableBody');
            listingsBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Loading Inventory...</td></tr>';
            
            const { data: listings, error } = await supabase
                .from('food_listings')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                listingsBody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: var(--accent-red);">Error loading inventory: ${error.message}</td></tr>`;
                return;
            }

            listingsBody.innerHTML = '';
            listings.forEach(item => {
                const statusClass = `status-${item.status}`;
                const row = `
                    <tr>
                        <td>${item.id}</td>
                        <td><strong>${item.title}</strong><br><small>(${item.category})</small></td>
                        <td>${item.quantity_kg} kg</td>
                        <td>${item.location_island}</td>
                        <td>${item.best_before_date || 'N/A'}</td>
                        <td><span class="status-badge ${statusClass}">${item.status}</span></td>
                        <td>${item.description.substring(0, 50)}...</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editListing(${item.id})"><i class="fas fa-edit"></i> Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteListing(${item.id})"><i class="fas fa-trash"></i> Delete</button>
                        </td>
                    </tr>
                `;
                listingsBody.insertAdjacentHTML('beforeend', row);
            });
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const listingData = {
                title: formData.get('title'),
                category: formData.get('category'),
                quantity_kg: parseFloat(formData.get('quantity_kg')), 
                location_island: formData.get('location_island'),
                best_before_date: formData.get('best_before_date') || null,
                storage_condition: formData.get('storage_condition'),
                description: formData.get('description'),
                status: formData.get('status')
            };

            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').textContent = 'Processing...';

            let response;
            if (editingId) {
                // Update operation
                response = await supabase
                    .from('food_listings')
                    .update(listingData)
                    .eq('id', editingId);
            } else {
                // Insert operation
                response = await supabase
                    .from('food_listings')
                    .insert([listingData]);
            }
            
            if (response.error) {
                alert(`Operation Failed: ${response.error.message}`);
            } else {
                alert(`Listing ${editingId ? 'updated' : 'added'} successfully!`);
                clearForm();
                fetchListings();
            }

            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').textContent = editingId ? 'Update Listing' : 'Add Listing';
        }

        async function editListing(id) {
            const { data: item, error } = await supabase
                .from('food_listings')
                .select('*')
                .eq('id', id)
                .single();

            if (error) {
                alert('Could not fetch item for editing.');
                return;
            }
            
            // Populate form fields
            document.getElementById('formTitle').textContent = `Edit Item: ${item.title}`;
            document.getElementById('submitBtn').textContent = 'Update Listing';
            editingId = id;

            document.getElementById('title').value = item.title;
            document.getElementById('category').value = item.category;
            document.getElementById('quantity_kg').value = item.quantity_kg;
            document.getElementById('location_island').value = item.location_island;
            document.getElementById('best_before_date').value = item.best_before_date;
            document.getElementById('storage_condition').value = item.storage_condition;
            document.getElementById('description').value = item.description;
            document.getElementById('status').value = item.status;
            
            window.scrollTo(0, 0); // Scroll to form
        }

        async function deleteListing(id) {
            if (!confirm('Are you sure you want to delete this food listing? This action cannot be undone.')) {
                return;
            }
            
            const { error } = await supabase
                .from('food_listings')
                .delete()
                .eq('id', id);

            if (error) {
                alert(`Deletion Failed: ${error.message}`);
            } else {
                alert('Listing deleted successfully.');
                fetchListings();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkAccessAndRedirect();
            document.getElementById('inventoryForm').addEventListener('submit', handleFormSubmit);
        });
    </script>
</head>
<body>
    <header id="navbar">
        <a href="/" class="logo-container">
            <img src="../image/logo.png" alt="FoodShare Seychelles Logo" class="logo-img"> 
            FoodShare <span style="color: var(--primary-main);">Admin</span>
        </a>
        <nav class="nav-links-container" id="navLinks">
            <a href="/admin/dashboard.html" class="nav-link">Dashboard</a>
            <a href="/admin/inventory-manage.html" class="nav-link cta-button">Inventory</a>
            <a href="/admin/user-manage.html" class="nav-link">Users</a>
            <a onclick="supabase.auth.signOut().then(() => { window.location.href = '/staff-login/index.html'; })" class="nav-link" style="cursor: pointer;">Logout</a> 
        </nav>
    </header>

    <main>
        <div class="content-container">
            <h1><i class="fas fa-boxes"></i> Inventory Management</h1>
            <p style="text-align: center; margin-bottom: 30px;">
                Add new food listings or update the status and quantity of existing stock.
            </p>

            <div class="grid-container">
                <div class="form-card">
                    <h2 id="formTitle">Add New Inventory Item</h2>
                    <form id="inventoryForm">
                        
                        <label for="title">Item Title *</label>
                        <input type="text" id="title" name="title" required placeholder="e.g., 20kg Bag of Local Potatoes">

                        <label for="category">Category *</label>
                        <select id="category" name="category" required>
                            <option value="Produce">Produce</option>
                            <option value="Packaged">Packaged Goods</option>
                            <option value="Meat">Meat/Fish</option>
                            <option value="Dairy">Dairy</option>
                            <option value="Other">Other</option>
                        </select>

                        <label for="quantity_kg">Quantity (kg) *</label>
                        <input type="number" id="quantity_kg" name="quantity_kg" step="0.1" min="0.1" required>

                        <label for="best_before_date">Best Before/Expiry Date</label>
                        <input type="date" id="best_before_date" name="best_before_date">
                        
                        <label for="location_island">Location Island *</label>
                        <select id="location_island" name="location_island" required>
                            <option value="Mahe">Mah√©</option>
                            <option value="Praslin">Praslin</option>
                            <option value="La Digue">La Digue</option>
                        </select>

                        <label for="storage_condition">Storage Condition</label>
                        <select id="storage_condition" name="storage_condition">
                            <option value="Ambient">Ambient</option>
                            <option value="Refrigerated">Refrigerated</option>
                            <option value="Frozen">Frozen</option>
                        </select>
                        
                        <label for="status">Listing Status *</label>
                        <select id="status" name="status" required>
                            <option value="Available">Available</option>
                            <option value="Pending Pickup">Pending Pickup</option>
                            <option value="Out of Stock">Out of Stock</option>
                            <option value="Archived">Archived</option>
                        </select>

                        <label for="description">Detailed Description</label>
                        <textarea id="description" name="description" rows="3" placeholder="Notes on quality, packaging, and specific collection details..."></textarea>
                        
                        <button type="submit" id="submitBtn">
                            <i class="fas fa-plus-circle"></i> Add Listing
                        </button>
                        <button type="button" onclick="clearForm()" style="background: #ccc; color: var(--text-dark); margin-top: 10px; width: 100%;">Clear/Cancel Edit</button>
                    </form>
                </div>

                <div>
                    <h2>Current Active Inventory <i class="fas fa-list"></i></h2>
                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Item</th>
                                <th>Qty (kg)</th>
                                <th>Location</th>
                                <th>Expiry</th>
                                <th>Status</th>
                                <th>Description Snippet</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="listingsTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer>
        </footer>
</body>
</html>
