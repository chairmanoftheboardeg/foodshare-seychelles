<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - FoodShare Seychelles</title>
    
    <link rel="icon" href="../image/logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    
    <style>
        /* [Standard CSS Block Omitted for brevity] */
        :root {
            --primary-light: #81C784; --primary-main: #4CAF50; --primary-dark: #388E3C; 
            --accent-blue: #2196F3; --accent-orange: #FF9800; --accent-red: #D32F2F;
            --neutral-bg: #F9F9F9; --neutral-card: #FFFFFF; --text-dark: #333333; 
            --text-light: #666666; --shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.08);
            --font-serif: 'Georgia', serif; --font-sans: 'Helvetica Neue', Arial, sans-serif;
            --transition-speed: 0.4s;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-sans); color: var(--text-dark); background-color: var(--neutral-bg); line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; }
        a { text-decoration: none; color: var(--primary-main); transition: color var(--transition-speed); }
        a:hover { color: var(--primary-dark); }
        main { flex-grow: 1; padding: 40px 0; }
        h1, h2, h3 { font-family: var(--font-serif); color: var(--primary-dark); }
        .content-container { max-width: 1400px; margin: 0 auto; padding: 0 25px; } 

        /* Navigation Bar */
        #navbar { display: flex; justify-content: space-between; align-items: center; padding: 18px 25px; background-color: var(--neutral-card); box-shadow: var(--shadow-subtle); position: sticky; top: 0; z-index: 1000; }
        .logo-container { display: flex; align-items: center; font-size: 1.6em; font-weight: bold; color: var(--text-dark); }
        .logo-img { height: 40px; margin-right: 10px; }
        .nav-links-container { display: flex; gap: 30px; align-items: center; }
        .nav-link { font-weight: 500; padding: 8px 0; position: relative; color: var(--text-dark); }
        .nav-link::after { content: ''; position: absolute; width: 0; height: 2px; bottom: -5px; left: 0; background-color: var(--primary-main); transition: width var(--transition-speed); }
        .nav-link:hover::after { width: 100%; }
        .cta-button { background-color: var(--primary-main); color: var(--neutral-card); border-radius: 50px; padding: 10px 25px; font-weight: bold; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: background-color var(--transition-speed), transform 0.2s; }
        .cta-button:hover { background-color: var(--primary-dark); transform: translateY(-2px); }

        /* Dashboard Specific Styles */
        h1 { text-align: center; margin-bottom: 30px; }
        .tab-container { display: flex; flex-wrap: wrap; margin-bottom: 20px; border-bottom: 2px solid #ccc; }
        .tab-button { 
            background: #eee; border: none; padding: 12px 18px; cursor: pointer; font-size: 0.95em; 
            font-weight: bold; border-top-left-radius: 8px; border-top-right-radius: 8px; 
            margin-right: 5px; transition: background 0.3s, color 0.3s; margin-bottom: -2px;
        }
        .tab-button.active { 
            background: var(--neutral-card); border: 1px solid #ccc; border-bottom: 2px solid var(--neutral-card); 
            color: var(--primary-dark); 
        }
        .tab-content { background: var(--neutral-card); padding: 30px; border-radius: 0 8px 8px 8px; box-shadow: var(--shadow-subtle); }
        
        /* Table Styles */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: left; font-size: 0.9em; }
        .data-table th { background-color: var(--primary-light); color: var(--text-dark); font-weight: bold; }
        .data-table tr:hover { background-color: #f5f5f5; }
        .data-table td a { color: var(--accent-blue); }
        
        /* Status Badges */
        .status-badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.8em; }
        .status-New, .status-Pending, .status-Reviewing, .status-Scheduled, .status-Inquiry { background-color: var(--accent-orange); color: white; }
        .status-Approved, .status-Collected, .status-Resolved { background-color: var(--primary-main); color: white; }
        .status-Rejected, .status-Cancelled, .status-Closed { background-color: var(--accent-red); color: white; }
        .status-VolApproved { background-color: var(--accent-blue); color: white; }

        /* Home/Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--neutral-bg); padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); text-align: center; }
        .stat-card h3 { font-size: 1.2em; color: var(--text-light); margin-bottom: 10px; }
        .stat-card p { font-size: 2.5em; font-weight: bold; color: var(--primary-dark); }

        /* Settings/Announcement Form */
        #settingsForm { max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        #settingsForm label { display: block; margin-top: 15px; font-weight: bold; }
        #settingsForm textarea, #settingsForm select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        #settingsForm button { background-color: var(--primary-main); color: white; padding: 10px 20px; border: none; border-radius: 4px; margin-top: 20px; cursor: pointer; }
        
        /* General Inquiry styles */
        .inquiry-detail { max-width: 400px; max-height: 100px; overflow-y: auto; background: #fafafa; padding: 8px; border-radius: 4px; font-size: 0.85em; }
    </style>
    
    <script>
        const SUPABASE_URL = 'https://edotvuleaydztulkxehe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkb3R2dWxlYXlkenR1bGt4ZWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDAyNDYsImV4cCI6MjA4MTE3NjI0Nn0.gDni31MI8twOpNmNcIpj1jGsra75eZ2iLL6gQM0i9lw';
        let supabase;

        const ADMIN_ROLE_ID = 1;
        const STAFF_ROLES = [2, 3];
        
        // --- Utility Functions ---

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }
        
        function showLoading(bodyId, colspan, message = 'Loading data...') {
            document.getElementById(bodyId).innerHTML = `<tr><td colspan="${colspan}" style="text-align: center;">${message}</td></tr>`;
        }

        // --- Tab Management ---

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            document.getElementById(tabName).style.display = 'block';
            document.querySelector(`.tab-button[onclick="openTab('${tabName}')"]`).classList.add('active');

            // Trigger fetch for the active tab
            if (tabName === 'home') {
                fetchStats();
            } else if (tabName === 'claims') {
                fetchClaims();
            } else if (tabName === 'donations') {
                fetchDonations();
            } else if (tabName === 'volunteers') {
                fetchVolunteers();
            } else if (tabName === 'inquiries') {
                fetchInquiries();
            } else if (tabName === 'settings') { // Corrected: Using 'settings'
                fetchAnnouncement();
            }
        }
        
        // --- ACCESS CONTROL: Admin Only ---
        async function checkAccessAndRedirect() {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            
            if (sessionError || !session) {
                window.location.href = '/staff-login/index.html';
                return;
            }

            const userId = session.user.id;
            
            const { data: profileData, error: profileError } = await supabase
                .from('profiles')
                .select('role')
                .eq('id', userId)
                .single();

            if (profileError || !profileData || profileData.role !== ADMIN_ROLE_ID) {
                const userRole = profileData ? profileData.role : null;
                
                if (STAFF_ROLES.includes(userRole)) {
                    // Redirect Role 2/3 staff to their personal dashboard
                    window.location.href = '/staff/dashboard.html';
                } else {
                    await supabase.auth.signOut();
                    window.location.href = '/staff-login/index.html';
                }
                return;
            }

            // User is Admin (Role 1): Initialize dashboard content
            openTab('home');
        }

        // --- HOME / STATS MODULE ---
        async function fetchStats() {
            // Placeholder: Implement actual Supabase queries here (e.g., using .rpc() for counts)
            const stats = {
                totalKg: 1500, // Mock Data
                newDonations: 8,
                pendingClaims: 12,
                newInquiries: 3
            };
            document.getElementById('statDonatedKg').textContent = `${stats.totalKg} kg`;
            document.getElementById('statNewDonations').textContent = stats.newDonations;
            document.getElementById('statPendingClaims').textContent = stats.pendingClaims;
            document.getElementById('statNewInquiries').textContent = stats.newInquiries;
        }

        // --- CLAIMS MODULE ---
        async function fetchClaims() {
            const claimsBody = document.getElementById('claimsTableBody');
            showLoading('claimsTableBody', 9);
            // Replace with actual Supabase fetch logic for 'claims' table
            claimsBody.innerHTML = '<tr><td colspan="9" style="text-align: center; font-style: italic;">Claims data will load here. (Implement fetchClaims function)</td></tr>';
        }
        
        async function changeClaimStatus(claimId, newStatus) {
            // Replace with Supabase update logic
            if (confirm(`Change status of claim ${claimId} to ${newStatus}?`)) { fetchClaims(); }
        }
        
        // --- DONATIONS MODULE ---
        async function fetchDonations() {
            const donationsBody = document.getElementById('donationsTableBody');
            showLoading('donationsTableBody', 9);
            // Replace with actual Supabase fetch logic for 'donations' table
            donationsBody.innerHTML = '<tr><td colspan="9" style="text-align: center; font-style: italic;">Donations data will load here. (Implement fetchDonations function)</td></tr>';
        }
        
        async function changeDonationStatus(donationId, newStatus) {
            // Replace with Supabase update logic
             if (confirm(`Change status of donation ${donationId} to ${newStatus}?`)) { fetchDonations(); }
        }

        // --- VOLUNTEER MODULE ---
        async function fetchVolunteers() {
            const volunteersBody = document.getElementById('volunteersTableBody');
            showLoading('volunteersTableBody', 8);
            // Replace with actual Supabase fetch logic for 'volunteer_applications' table
            volunteersBody.innerHTML = '<tr><td colspan="8" style="text-align: center; font-style: italic;">Volunteer data will load here. (Implement fetchVolunteers function)</td></tr>';
        }

        async function changeVolunteerStatus(appId, newStatus) {
            // Replace with Supabase update logic
             if (confirm(`Change status of application ${appId} to ${newStatus}?`)) { fetchVolunteers(); }
        }

        // --- GENERAL INQUIRIES MODULE ---
        async function fetchInquiries() {
            const inquiriesBody = document.getElementById('inquiriesTableBody');
            showLoading('inquiriesTableBody', 6);
            // Replace with actual Supabase fetch logic for 'general_inquiries' table
            inquiriesBody.innerHTML = '<tr><td colspan="6" style="text-align: center; font-style: italic;">Inquiries data will load here. (Implement fetchInquiries function)</td></tr>';
        }
        
        async function changeInquiryStatus(inquiryId, newStatus) {
            // Replace with Supabase update logic
             if (confirm(`Change status of inquiry ${inquiryId} to ${newStatus}?`)) { fetchInquiries(); }
        }
        
        // --- SETTINGS / ANNOUNCEMENT MODULE (Corrected) ---
        async function fetchAnnouncement() {
            const { data, error } = await supabase
                .from('announcements')
                .select('*')
                .limit(1)
                .single();

            if (error && error.code !== 'PGRST116') { // PGRST116 is 'No rows returned'
                 document.getElementById('announcementText').value = "Error loading previous announcement.";
                 return;
            }
            
            if (data) {
                document.getElementById('announcementText').value = data.content || '';
                document.getElementById('announcementType').value = data.type || 'info';
                document.getElementById('currentAnnouncementId').value = data.id;
            } else {
                 // Ensure fields are clear if no announcement exists
                 document.getElementById('announcementText').value = '';
                 document.getElementById('announcementType').value = 'info';
                 document.getElementById('currentAnnouncementId').value = '';
            }
        }
        
        async function handleAnnouncementSubmit(event) {
            event.preventDefault();
            
            const content = document.getElementById('announcementText').value;
            const type = document.getElementById('announcementType').value;
            const id = document.getElementById('currentAnnouncementId').value;
            
            const submitBtn = document.getElementById('announcementSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            let error = null;
            let data = null;

            if (id) {
                // Update existing announcement
                ({ error } = await supabase
                    .from('announcements')
                    .update({ content: content, type: type, updated_at: new Date() })
                    .eq('id', id));
                if (!error) { alert('Settings (Announcement) updated successfully!'); } 
            } else {
                // Insert new announcement
                 ({ data, error } = await supabase
                    .from('announcements')
                    .insert([{ content: content, type: type }])
                    .select('id'));
                 if (!error) { 
                    alert('Settings (Announcement) created successfully!'); 
                    document.getElementById('currentAnnouncementId').value = data[0].id;
                 }
            }

            if (error) { alert('Error processing announcement settings: ' + error.message); }
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Settings';
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAccessAndRedirect();
            document.getElementById('settingsForm').addEventListener('submit', handleAnnouncementSubmit); // Corrected form ID
        });
    </script>
</head>
<body>
    <header id="navbar">
        <a href="/" class="logo-container">
            <img src="../image/logo.png" alt="FoodShare Seychelles Logo" class="logo-img"> 
            FoodShare <span style="color: var(--primary-main);">Admin</span>
        </a>
        <nav class="nav-links-container" id="navLinks">
            <a onclick="supabase.auth.signOut().then(() => { window.location.href = '/staff-login/index.html'; })" class="nav-link" style="cursor: pointer;">Logout</a> 
        </nav>
    </header>

    <main>
        <div class="content-container">
            <h1><i class="fas fa-tools"></i> Administrative Management Panel</h1>
            <p style="text-align: center; color: var(--accent-red); margin-bottom: 20px;">
                <i class="fas fa-lock"></i> **RESTRICTED ACCESS:** Only users with Admin Role (ID 1) can view this page.
            </p>

            <div class="tab-container">
                <button class="tab-button active" onclick="openTab('home')"><i class="fas fa-chart-line"></i> Home</button>
                <button class="tab-button" onclick="openTab('claims')"><i class="fas fa-hand-holding-heart"></i> Claims</button>
                <button class="tab-button" onclick="openTab('donations')"><i class="fas fa-hand-holding-usd"></i> Donations</button>
                <button class="tab-button" onclick="openTab('volunteers')"><i class="fas fa-hands-helping"></i> Volunteer Applications</button>
                <button class="tab-button" onclick="openTab('inquiries')"><i class="fas fa-question-circle"></i> General Inquiries</button>
                <button class="tab-button" onclick="openTab('assign-task')"><i class="fas fa-tasks"></i> Assign Task</button>
                <button class="tab-button" onclick="openTab('settings')"><i class="fas fa-cogs"></i> Settings</button> </div>
            
            <div id="home" class="tab-content">
                <h2>System Overview and Quick Stats</h2>
                <div class="stats-grid">
                    <div class="stat-card" style="border-left: 5px solid var(--primary-main);">
                        <h3>Total Food Donated (Lifetime)</h3>
                        <p id="statDonatedKg">0 kg</p>
                    </div>
                    <div class="stat-card" style="border-left: 5px solid var(--accent-orange);">
                        <h3>New Donation Requests</h3>
                        <p id="statNewDonations">0</p>
                    </div>
                    <div class="stat-card" style="border-left: 5px solid var(--accent-red);">
                        <h3>Pending Claims</h3>
                        <p id="statPendingClaims">0</p>
                    </div>
                    <div class="stat-card" style="border-left: 5px solid var(--accent-blue);">
                        <h3>New General Inquiries</h3>
                        <p id="statNewInquiries">0</p>
                    </div>
                </div>
            </div>

            <div id="claims" class="tab-content" style="display:none;">
                <h2>Recent Food Claims</h2>
                <table class="data-table">
                    <tbody id="claimsTableBody"></tbody>
                </table>
            </div>

            <div id="donations" class="tab-content" style="display:none;">
                <h2>Incoming Donation Requests</h2>
                <table class="data-table">
                    <tbody id="donationsTableBody"></tbody>
                </table>
            </div>

            <div id="volunteers" class="tab-content" style="display:none;">
                <h2>Volunteer Applications</h2>
                <table class="data-table">
                    <tbody id="volunteersTableBody"></tbody>
                </table>
            </div>
            
            <div id="inquiries" class="tab-content" style="display:none;">
                <h2>General Contact Inquiries</h2>
                <table class="data-table">
                    <tbody id="inquiriesTableBody"></tbody>
                </table>
            </div>
            
            <div id="assign-task" class="tab-content" style="display:none;">
                <h2>Assign Tasks to Staff/Drivers</h2>
                <p>This will be the central control for staff assignments.</p>
                <div style="padding: 30px; background: #f0f0f0; border-radius: 8px; text-align: center;">
                    <p style="font-weight: bold;">This feature will be developed after the personal staff dashboard to ensure assignment workflow is supported.</p>
                </div>
            </div>

            <div id="settings" class="tab-content" style="display:none;">
                <h2>System Settings: Public Announcements</h2>
                <p>Set a banner announcement to appear on the main site pages.</p>
                <form id="settingsForm"> <input type="hidden" id="currentAnnouncementId" value="">

                    <label for="announcementType">Announcement Type (Color Code)</label>
                    <select id="announcementType" name="announcementType">
                        <option value="info">Info (Blue)</option>
                        <option value="warning">Warning (Orange)</option>
                        <option value="critical">Critical (Red)</option>
                        <option value="success">Success (Green)</option>
                    </select>

                    <label for="announcementText">Announcement Content</label>
                    <textarea id="announcementText" name="announcementText" rows="4" required placeholder="Enter the announcement text here..."></textarea>
                    
                    <button type="submit" id="announcementSubmitBtn">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </form>
            </div>

        </div>
    </main>

    <footer id="main-footer">
        <div class="content-container footer-content">
            <div class="footer-section"><h3>Quick Links</h3><ul><li><a href="/available-food/">Find Food</a></li><li><a href="/donate-food/">Donate Food</a></li><li><a href="/volunteer/">Volunteer</a></li><li><a href="/impact/">Impact & Reports</a></li><li><a href="/contact-general/">General Contact</a></li></ul></div>
            <div class="footer-section"><h3>Learn More</h3><ul><li><a href="/about/">About FoodShare</a></li><li><a href="/our-partners/">Our Partners</a></li><li><a href="/learn/safety/">Food Safety Protocol</a></li><li><a href="/learn/faq/">General FAQ</a></li></ul></div>
            <div class="footer-section"><h3>Support & Legal</h3><ul><li><a href="/privacy-policy/">Privacy Policy</a></li><li><a href="/terms-of-use/">Terms of Use</a></li><li><a href="/sitemap/">Site Structure</a></li><li><a href="/staff-login/">Staff Login</a></li></ul></div>
            <div class="footer-section">
                <h3>Get In Touch</h3>
                <p>Email: <a href="mailto:admin@foodshare-seychelles.online" style="color: var(--primary-main);">admin@foodshare-seychelles.online</a></p>
                <p>Follow us on <a href="/social/" style="color: var(--primary-main); display: inline;">Social Media</a></p>
            </div>
        </div>
        <div class="footer-bottom">Â© 2025 Foodshare Seychelles. All Rights Reserved.</div>
    </footer>
</body>
</html>
