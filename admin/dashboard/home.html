<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Home</title>
    <link rel="icon" href="../../image/logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    
    <style>
        /* [Admin CSS Base] */
        :root {
            --primary-main: #4CAF50; 
            --primary-dark: #388E3C;
            --accent-blue: #2196F3;
            --accent-red: #D32F2F;
            --neutral-bg: #F5F7FA; 
            --neutral-card: #FFFFFF;
            --text-dark: #2C3E50; 
            --text-light: #7f8c8d;
            --shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; background-color: var(--neutral-bg); color: var(--text-dark); display: flex; }
        
        /* Sidebar Styling (Placeholder - assumes full implementation in a separate CSS file eventually) */
        #sidebar { 
            width: 250px; 
            background: var(--text-dark); 
            color: white; 
            height: 100vh; 
            padding-top: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        #sidebar h2 { padding: 0 20px 20px; border-bottom: 1px solid #444; margin-bottom: 20px; }
        #sidebar a { 
            display: block; 
            padding: 12px 20px; 
            text-decoration: none; 
            color: #ddd; 
            transition: background 0.2s, color 0.2s;
            border-left: 5px solid transparent;
        }
        #sidebar a:hover { background: #3c4a5c; color: white; }
        #sidebar a.active { background: #3c4a5c; color: var(--primary-main); border-left-color: var(--primary-main); }

        /* Main Content */
        #main-content { flex-grow: 1; padding: 40px; }
        .dashboard-header { margin-bottom: 30px; border-bottom: 1px solid #ddd; padding-bottom: 15px; }
        .dashboard-header h1 { color: var(--accent-blue); }

        /* Widget Styling */
        .widget-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 25px; 
        }
        .widget {
            background: var(--neutral-card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-subtle);
            text-align: center;
            transition: transform 0.2s;
        }
        .widget:hover { transform: translateY(-5px); }
        .widget i { font-size: 3em; color: var(--primary-main); margin-bottom: 10px; }
        .widget h3 { font-size: 1.8em; margin: 5px 0; color: var(--text-dark); }
        .widget p { color: var(--text-light); }
        .widget.red i { color: var(--accent-red); }
        .widget.blue i { color: var(--accent-blue); }
    </style>
    
    <script>
        const SUPABASE_URL = 'https://edotvuleaydztulkxehe.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkb3R2dWxlYXlkenR1bGt4ZWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDAyNDYsImV4cCI6MjA4MTE3NjI0Nn0.gDni31MI8twOpNmNcIpj1jGsra75eZ2iLL6gQM0i9lw';
        let supabase;

        const ADMIN_ROLE_ID = 1;
        const STAFF_ROLES = [2, 3]; 
        let currentUserId = null;
        
        // --- Core Access Control: The Admin Dashboard Guard ---
        async function authGuard(allowedRoles) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = '/staff-login/index.html';
                return null;
            }

            currentUserId = session.user.id;
            
            const { data: profileData, error: profileError } = await supabase
                .from('profiles')
                .select('role, full_name')
                .eq('id', currentUserId)
                .single();

            if (profileError || !profileData) {
                // RLS or Missing Profile error: Kicks user back to login
                await supabase.auth.signOut();
                window.location.href = '/staff-login/index.html?error=profile_access_denied';
                return null;
            }
            
            const userRole = profileData.role;
            
            if (!allowedRoles.includes(userRole)) {
                 // Unauthorized role for this page (e.g., staff tries admin portal)
                 if (STAFF_ROLES.includes(userRole)) {
                     // Redirect staff members to the staff dashboard
                     window.location.href = '/staff/dashboard.html';
                     return null;
                 }
                 // Unauthorized user logs out
                 await supabase.auth.signOut();
                 window.location.href = '/staff-login/index.html?error=unauthorized_role';
                 return null;
            }

            return profileData;
        }

        async function loadDashboardData() {
            // Function to fetch counts for the widgets (Donations, Claims, etc.)
            
            // Example: Fetch count of 'New Request' donations
            const { count: newDonations } = await supabase
                .from('donations')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'New Request');

            document.getElementById('donationsCount').textContent = newDonations || 0;
            
            // Example: Fetch count of 'New Review' claims
             const { count: newClaims } = await supabase
                .from('claims')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'New Review');

            document.getElementById('claimsCount').textContent = newClaims || 0;

            // Example: Total Staff/Volunteers (Roles 2, 3, 4)
             const { count: totalStaff } = await supabase
                .from('profiles')
                .select('*', { count: 'exact', head: true })
                .neq('role', ADMIN_ROLE_ID); // Exclude admin

            document.getElementById('staffCount').textContent = totalStaff || 0;
        }

        function displayAdminName(name) {
            document.getElementById('adminName').textContent = name || 'Administrator';
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            const profile = await authGuard([ADMIN_ROLE_ID]); // Only allow Admin
            if (profile) {
                displayAdminName(profile.full_name);
                loadDashboardData();
            }
        });
    </script>
</head>
<body>
    <div id="sidebar">
        <h2><i class="fas fa-crown" style="color: var(--primary-main);"></i> Admin Portal</h2>
        <a href="home.html" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard Home</a>
        <a href="donations.html"><i class="fas fa-boxes"></i> Donations Intake</a>
        <a href="claims.html"><i class="fas fa-clipboard-list"></i> Claims Review</a>
        <a href="inventory.html"><i class="fas fa-warehouse"></i> Inventory Mgmt</a>
        <a href="tasks.html"><i class="fas fa-tasks"></i> Staff Tasks</a>
        <a href="volunteers.html"><i class="fas fa-users"></i> Volunteer Apps</a>
        <a href="inquiries.html"><i class="fas fa-question-circle"></i> General Inquiries</a>
        <hr style="border-color: #444; margin: 15px 20px;">
        <a href="#" onclick="supabase.auth.signOut().then(() => { window.location.href = '/staff-login/index.html'; })"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <div id="main-content">
        <div class="dashboard-header">
            <h1>Welcome Back, <span id="adminName">Administrator</span></h1>
            <p style="color: var(--text-light);">System Overview and Critical Action Items</p>
        </div>

        <div class="widget-grid">
            
            <a href="donations.html" style="text-decoration: none;">
                <div class="widget">
                    <i class="fas fa-box-open" style="color: var(--primary-dark);"></i>
                    <h3 id="donationsCount">0</h3>
                    <p>New Donation Requests</p>
                </div>
            </a>

            <a href="claims.html" style="text-decoration: none;">
                <div class="widget red">
                    <i class="fas fa-hand-holding-medical"></i>
                    <h3 id="claimsCount">0</h3>
                    <p>Pending Claims for Review</p>
                </div>
            </a>
            
            <a href="volunteers.html" style="text-decoration: none;">
                <div class="widget blue">
                    <i class="fas fa-user-friends"></i>
                    <h3 id="staffCount">0</h3>
                    <p>Total Staff & Volunteers</p>
                </div>
            </a>

            <a href="inquiries.html" style="text-decoration: none;">
                <div class="widget">
                    <i class="fas fa-envelope-open-text" style="color: #FF9800;"></i>
                    <h3 id="inquiryCount">0</h3>
                    <p>Unread General Inquiries</p>
                </div>
            </a>

        </div>
        
        <div style="margin-top: 50px; padding: 25px; background: white; border-radius: 12px; box-shadow: var(--shadow-subtle);">
            <h2>System Health & Activity Log</h2>
            <p>Recent high-priority activity log will appear here...</p>
        </div>
    </div>
</body>
</html>
