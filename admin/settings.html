<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Settings - FoodShare Seychelles</title>
    
    <link rel="icon" href="../../image/logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    
    <style>
        /* ======================================================= */
        /* BASE STYLES & ADMIN LAYOUT (Adapted from Home Page) */
        /* ======================================================= */
        :root {
            --primary-light: #81C784; --primary-main: #4CAF50; --primary-dark: #388E3C;
            --neutral-bg: #F0F2F5; --neutral-card: #FFFFFF; --text-dark: #333333;
            --danger-main: #E53935; --danger-light: #FFCDD2;
            --shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.08);
            --font-sans: 'Helvetica Neue', Arial, sans-serif;
            --transition-speed: 0.3s;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-sans); color: var(--text-dark); background-color: var(--neutral-bg); min-height: 100vh; display: flex; }
        
        /* Main Content and Container */
        main { flex-grow: 1; padding: 30px; }
        .content-container { max-width: 900px; margin: 0 auto; }
        h1 { color: var(--primary-dark); margin-bottom: 25px; font-size: 2em; }
        h2 { color: var(--text-dark); margin-bottom: 15px; font-size: 1.5em; border-bottom: 2px solid var(--primary-light); padding-bottom: 5px; }
        
        /* Dashboard Sidebar */
        #sidebar {
            width: 250px; background-color: var(--text-dark); color: var(--neutral-card);
            padding: 20px 0; box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1); flex-shrink: 0;
        }
        .logo-admin { text-align: center; margin-bottom: 30px; font-size: 1.4em; color: var(--primary-light); font-weight: bold; }
        #sidebar a {
            display: flex; align-items: center; padding: 15px 20px; color: var(--neutral-card);
            text-decoration: none; transition: background-color var(--transition-speed), color var(--transition-speed);
        }
        #sidebar a i { margin-right: 10px; font-size: 1.1em; }
        #sidebar a:hover { background-color: #333; color: var(--primary-main); }
        #sidebar a.active { background-color: var(--primary-main); color: var(--neutral-card); font-weight: bold; }
        #logout-btn {
            background-color: var(--danger-main); color: white; border: none;
            width: 80%; margin: 30px auto 0; padding: 10px; border-radius: 5px;
            cursor: pointer; transition: background-color var(--transition-speed);
            display: block; text-align: center;
        }
        #logout-btn:hover { background-color: var(--danger-light); color: var(--danger-main); }

        /* Form and Card Styling */
        .card {
            background-color: var(--neutral-card); padding: 30px; border-radius: 8px;
            box-shadow: var(--shadow-subtle); margin-bottom: 25px;
        }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-dark); }
        textarea, input[type="text"] {
            width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc;
            border-radius: 4px; font-size: 1em; resize: vertical; min-height: 100px;
        }
        .btn-primary {
            background-color: var(--primary-main); color: white; padding: 12px 25px;
            border: none; border-radius: 5px; cursor: pointer; font-size: 1em;
            transition: background-color var(--transition-speed);
        }
        .btn-primary:hover { background-color: var(--primary-dark); }
        
        /* Messages */
        #status-message {
            padding: 15px; margin-bottom: 20px; border-radius: 5px;
            text-align: center; font-weight: bold; display: none;
        }
        .success { background-color: var(--primary-light); color: var(--primary-dark); }
        .error { background-color: var(--danger-light); color: var(--danger-main); }
        
        /* Preloader for security check */
        #auth-preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--neutral-bg); z-index: 10000; display: flex; justify-content: center; align-items: center; font-size: 1.5em; }
        .hidden { display: none !important; }
    </style>
    
    <script>
        const SUPABASE_URL = 'https://edotvuleaydztulkxehe.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkb3R2dWxlYXlkenR1bGt4ZWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDAyNDYsImV4cCI6MjA4MTE3NjI0Nn0.gDni31MI8twOpNmNcIpj1jGsra75eZ2iLL6gQM0i9lw';
        let supabase;
        
        const ADMIN_ROLE_ID = 1;

        function showMessage(type, message) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = '';
            statusEl.classList.add(type);
            statusEl.style.display = 'block';
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        async function checkAdminAuth() {
            const preloader = document.getElementById('auth-preloader');
            preloader.textContent = "Verifying Credentials...";
            
            try {
                // 1. Get the current user session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError || !session) {
                    console.warn("No active session found. Redirecting.");
                    window.location.href = '../../staff-login/index.html';
                    return;
                }

                const user = session.user;

                // 2. Fetch the user's profile to get the role_id
                // *** FIX APPLIED: Using 'id' column as the foreign key in profiles table ***
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('role_id')
                    .eq('id', user.id) // <--- CRITICAL FIX based on your table schema
                    .single();

                if (profileError || !profile || profile.role_id !== ADMIN_ROLE_ID) {
                    console.error("Authorization failed. Role is not Admin.", profileError || 'Role mismatch');
                    // Redirect unauthorized users
                    window.location.href = '../../staff-login/index.html'; 
                    return;
                }

                // Authentication successful
                preloader.classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
                fetchAnnouncementSettings();
            
            } catch (e) {
                console.error("Authentication check failed:", e);
                window.location.href = '../../staff-login/index.html';
            }
        }

        async function fetchAnnouncementSettings() {
            const textarea = document.getElementById('announcement-value');
            
            const { data, error } = await supabase
                .from('settings')
                .select('value')
                .eq('key', 'home_announcement')
                .single();

            if (error) {
                console.error("Error fetching current setting:", error);
                // Fallback message if fetch fails
                textarea.value = "ERROR: Failed to load current announcement value."; 
                return;
            }
            
            // Populate the text area with the current value
            textarea.value = data?.value || ''; 
        }

        async function updateAnnouncement(event) {
            event.preventDefault();
            const newAnnouncement = document.getElementById('announcement-value').value.trim();
            
            // Update the specific setting key
            const { error } = await supabase
                .from('settings')
                .update({ value: newAnnouncement, updated_at: new Date().toISOString() })
                .eq('key', 'home_announcement');

            if (error) {
                console.error("Error updating announcement:", error);
                showMessage('error', `Failed to update announcement: ${error.message}`);
            } else {
                showMessage('success', 'âœ… Announcement Banner updated successfully!');
            }
        }

        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Logout error:", error);
                alert("Logout failed. Please try again.");
            } else {
                window.location.href = '../../staff-login/index.html';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                checkAdminAuth();
            } else {
                console.error("Supabase client failed to load.");
            }

            document.getElementById('announcement-form').addEventListener('submit', updateAnnouncement);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        });
    </script>
</head>
<body>

    <div id="auth-preloader">Checking Authorization...</div>

    <aside id="sidebar">
        <div class="logo-admin">FoodShare Admin</div>
        <nav>
            <a href="dashboard.html"><i class="fas fa-chart-line"></i> Dashboard Home</a>
            <a href="inventory.html"><i class="fas fa-boxes"></i> Inventory Management</a>
            <a href="requests.html"><i class="fas fa-list-alt"></i> Donation Requests</a>
            <a href="tasks.html"><i class="fas fa-tasks"></i> Staff Tasks</a>
            <a href="volunteers.html"><i class="fas fa-user-friends"></i> Volunteer Apps</a>
            <a href="settings.html" class="active"><i class="fas fa-cog"></i> Site Settings</a>
        </nav>
        <button id="logout-btn">Logout</button>
    </aside>

    <main id="admin-content" class="hidden">
        <div class="content-container">
            <h1>Admin Settings</h1>
            
            <div id="status-message"></div>

            <div class="card">
                <h2><i class="fas fa-bullhorn"></i> Home Page Announcement Banner</h2>
                <form id="announcement-form">
                    <p style="margin-bottom: 20px; color: var(--text-dark);">This message appears at the top of the public Home Page. **Leave the text box empty to hide the banner completely.**</p>
                    
                    <label for="announcement-value">Announcement Content:</label>
                    <textarea id="announcement-value" placeholder="Enter your key operational announcement here..."></textarea>
                    
                    <button type="submit" class="btn-primary">Save Announcement</button>
                </form>
            </div>

            <div class="card">
                <h2><i class="fas fa-envelope"></i> Default Email Notifications</h2>
                <p style="color: var(--text-dark);">*Future feature: Configure default subject lines and body text for automated emails sent to donors and volunteers.</p>
            </div>

        </div>
    </main>
</body>
</html>
