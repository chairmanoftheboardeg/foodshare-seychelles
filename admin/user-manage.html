<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - FoodShare Seychelles</title>
    
    <link rel="icon" href="../image/logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    
    <style>
        /* [Standard CSS Block Omitted for brevity] */
        :root {
            --primary-light: #81C784; --primary-main: #4CAF50; --primary-dark: #388E3C; 
            --accent-blue: #2196F3; --accent-orange: #FF9800; --accent-red: #D32F2F;
            --neutral-bg: #F9F9F9; --neutral-card: #FFFFFF; --text-dark: #333333; 
            --text-light: #666666; --shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.08);
            --font-serif: 'Georgia', serif; --font-sans: 'Helvetica Neue', Arial, sans-serif;
            --transition-speed: 0.4s;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-sans); color: var(--text-dark); background-color: var(--neutral-bg); line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; }
        a { text-decoration: none; color: var(--primary-main); transition: color var(--transition-speed); }
        a:hover { color: var(--primary-dark); }
        main { flex-grow: 1; padding: 40px 0; }
        h1, h2, h3 { font-family: var(--font-serif); color: var(--primary-dark); }
        .content-container { max-width: 1200px; margin: 0 auto; padding: 0 25px; } 

        /* Navigation Bar */
        #navbar { display: flex; justify-content: space-between; align-items: center; padding: 18px 25px; background-color: var(--neutral-card); box-shadow: var(--shadow-subtle); position: sticky; top: 0; z-index: 1000; }
        .logo-container { display: flex; align-items: center; font-size: 1.6em; font-weight: bold; color: var(--text-dark); }
        .logo-img { height: 40px; margin-right: 10px; }
        .nav-links-container { display: flex; gap: 30px; align-items: center; }
        .nav-link { font-weight: 500; padding: 8px 0; position: relative; color: var(--text-dark); }
        
        /* Table Styles */
        .user-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .user-table th, .user-table td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: left; font-size: 0.9em; }
        .user-table th { background-color: var(--primary-light); color: var(--text-dark); font-weight: bold; }
        .user-table tr:hover { background-color: #f5f5f5; }
        
        /* Role Badges */
        .role-badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.8em; }
        .role-1 { background-color: var(--accent-red); color: white; } /* Admin */
        .role-2 { background-color: var(--accent-blue); color: white; } /* Driver/Staff */
        .role-3 { background-color: var(--primary-main); color: white; } /* Volunteer Coordinator */
        .role-4 { background-color: var(--neutral-bg); color: var(--text-dark); border: 1px solid #ccc; } /* General Volunteer */
        
        .action-select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }
    </style>
    
    <script>
        const SUPABASE_URL = 'https://edotvuleaydztulkxehe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkb3R2dWxlYXlkenR1bGt4ZWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDAyNDYsImV4cCI6MjA4MTE3NjI0Nn0.gDni31MI8twOpNmNcIpj1jGsra75eZ2iLL6gQM0i9lw';
        let supabase;
        const ADMIN_ROLE_ID = 1;
        const ROLE_MAP = {
            1: 'Admin',
            2: 'Driver/Staff',
            3: 'Volunteer Coordinator',
            4: 'General Volunteer'
        };

        // --- Core Functions ---

        async function checkAccessAndRedirect() {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = '/staff-login/index.html';
                return;
            }

            const { data: profileData, error } = await supabase
                .from('profiles')
                .select('role')
                .eq('id', session.user.id)
                .single();

            if (error || !profileData || profileData.role !== ADMIN_ROLE_ID) {
                window.location.href = '/staff-login/index.html'; 
                return;
            }
            
            fetchUsers();
        }
        
        async function fetchUsers() {
            const usersBody = document.getElementById('usersTableBody');
            usersBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Loading Staff and Volunteers...</td></tr>';
            
            // Fetch all profiles along with their user email from the auth schema
            const { data: profiles, error } = await supabase
                .from('profiles')
                .select(`id, full_name, role, phone, auth_users(email)`) // Assuming 'profiles' has a foreign key to auth.users
                .order('role', { ascending: true });

            if (error) {
                usersBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--accent-red);">Error loading users: ${error.message}</td></tr>`;
                return;
            }

            usersBody.innerHTML = '';
            profiles.forEach(profile => {
                const roleName = ROLE_MAP[profile.role] || 'Unknown';
                const roleClass = `role-${profile.role}`;
                const email = profile.auth_users ? profile.auth_users.email : 'N/A';
                
                const roleOptions = Object.entries(ROLE_MAP).map(([id, name]) => 
                    `<option value="${id}" ${profile.role == id ? 'selected' : ''}>${name}</option>`
                ).join('');
                
                const row = `
                    <tr>
                        <td>${profile.id.substring(0, 8)}...</td>
                        <td><strong>${profile.full_name}</strong></td>
                        <td>${email}</td>
                        <td>${profile.phone || 'N/A'}</td>
                        <td><span class="role-badge ${roleClass}">${roleName}</span></td>
                        <td>
                            <select class="action-select" onchange="updateUserRole('${profile.id}', this.value)">
                                ${roleOptions}
                            </select>
                        </td>
                    </tr>
                `;
                usersBody.insertAdjacentHTML('beforeend', row);
            });
        }
        
        async function updateUserRole(userId, newRoleId) {
            const roleName = ROLE_MAP[newRoleId];
            if (!confirm(`Are you sure you want to change the role for user ${userId.substring(0, 8)} to ${roleName}?`)) {
                fetchUsers(); // Revert selection
                return;
            }
            
            // Prevent Admin from demoting themselves (optional but recommended)
            const { data: { session } } = await supabase.auth.getSession();
            if (session.user.id === userId && newRoleId !== ADMIN_ROLE_ID) {
                alert("Security policy prevents you from demoting your own admin account. Have another admin do it.");
                fetchUsers();
                return;
            }

            const { error } = await supabase
                .from('profiles')
                .update({ role: parseInt(newRoleId) })
                .eq('id', userId);

            if (error) {
                alert(`Role Update Failed: ${error.message}`);
            } else {
                alert(`User role updated to ${roleName} successfully.`);
                fetchUsers(); // Refresh table
            }
        }
        
        // Note: Password reset and user creation should generally be handled through Supabase Admin console or an Admin-privileged backend function for security.

        document.addEventListener('DOMContentLoaded', () => {
            checkAccessAndRedirect();
        });
    </script>
</head>
<body>
    <header id="navbar">
        <a href="/" class="logo-container">
            <img src="../image/logo.png" alt="FoodShare Seychelles Logo" class="logo-img"> 
            FoodShare <span style="color: var(--primary-main);">Admin</span>
        </a>
        <nav class="nav-links-container" id="navLinks">
            <a href="/admin/dashboard.html" class="nav-link">Dashboard</a>
            <a href="/admin/inventory-manage.html" class="nav-link">Inventory</a>
            <a href="/admin/user-manage.html" class="nav-link cta-button">Users</a>
            <a onclick="supabase.auth.signOut().then(() => { window.location.href = '/staff-login/index.html'; })" class="nav-link" style="cursor: pointer;">Logout</a> 
        </nav>
    </header>

    <main>
        <div class="content-container">
            <h1><i class="fas fa-users-cog"></i> Staff and User Management</h1>
            <p style="text-align: center; margin-bottom: 30px;">
                Manage access, roles, and profiles for all staff and registered volunteers.
            </p>

            <div class="form-card" style="padding: 20px;">
                <h2>Current Staff & User Roles</h2>
                <p style="font-size: 0.9em; margin-bottom: 15px;">
                    **Role Key:** <span class="role-badge role-1">Admin (1)</span>, 
                    <span class="role-badge role-2">Driver/Staff (2)</span>, 
                    <span class="role-badge role-3">Volunteer Coordinator (3)</span>, 
                    <span class="role-badge role-4">General Volunteer (4)</span>
                </p>
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Current Role</th>
                            <th>Change Role</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        </tbody>
                </table>
            </div>
            
            <div style="margin-top: 40px; padding: 20px; border: 1px dashed #ccc; border-radius: 8px;">
                <p style="font-weight: bold; color: var(--accent-red);"><i class="fas fa-exclamation-triangle"></i> Security Note:</p>
                <p style="font-size: 0.9em;">User registration (onboarding new staff) and password resets should be managed securely via the Supabase Admin console to ensure all security protocols are followed.</p>
            </div>
        </div>
    </main>

    <footer>
        </footer>
</body>
</html>
